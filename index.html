<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lo-Fi 音樂拍立得</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <style>
    body { background: #fdf6e3; display: flex; flex-direction: column; align-items: center; font-family: sans-serif; padding-top: 50px; }
    #camera { width: 320px; height: 240px; border: 10px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: #333; }
    canvas { display: none; }
    .controls { margin-top: 20px; display: flex; gap: 10px; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; border: none; background: #859900; color: white; }
    button:disabled { background: #ccc; }
    #stopBtn { background: #dc322f; }
    .status { margin-top: 10px; font-size: 14px; color: #586e75; }
  </style>
</head>
<body>

  <video id="camera" autoplay playsinline></video>
  <canvas id="canvas" width="320" height="240"></canvas>

  <div class="controls">
    <button id="snapBtn">拍照</button>
    <button id="loadBtn">讀取照片</button>
    <button id="playBtn">播放音樂</button>
    <button id="stopBtn" disabled>停止</button>
  </div>
  <div class="status" id="statusText">請點擊拍照或讀取照片開始</div>

  <script>
    const video = document.getElementById('camera');
    const canvas = document.getElementById('canvas');
    const snapBtn = document.getElementById('snapBtn');
    const loadBtn = document.getElementById('loadBtn');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusText = document.getElementById('statusText');

    // --- 音樂變數 ---
    const synths = {};
    let asmrSynths = {};
    let audioInited = false;
    let currentFeatures = { bpm: 80, mode: 'Major', brightness: 0.5 };

    // --- 啟動相機 ---
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (err) {
        statusText.innerText = "無法啟動相機: " + err.name;
      }
    }
    startCamera();

    // --- 影像分析邏輯 ---
    function analyzeImage(imgData) {
      let rSum = 0, gSum = 0, bSum = 0;
      for (let i = 0; i < imgData.data.length; i += 4) {
        rSum += imgData.data[i];
        gSum += imgData.data[i+1];
        bSum += imgData.data[i+2];
      }
      const count = imgData.data.length / 4;
      const avgR = rSum / count, avgG = gSum / count, avgB = bSum / count;
      const brightness = (avgR + avgG + avgB) / (3 * 255);
      
      currentFeatures.bpm = 60 + Math.floor(brightness * 60);
      currentFeatures.mode = (avgB > avgR) ? 'Minor' : 'Major';
      currentFeatures.brightness = brightness;
      
      statusText.innerText = `分析完成: ${currentFeatures.mode} 調, 亮度: ${Math.round(brightness*100)}%`;
    }

    // --- 拍照與按鈕事件 ---
    snapBtn.addEventListener('click', () => {
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, 320, 240);
      analyzeImage(ctx.getImageData(0, 0, 320, 240));
    });

    loadBtn.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.onchange = e => {
        const file = e.target.files[0];
        const img = new Image();
        img.onload = () => {
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, 320, 240);
          analyzeImage(ctx.getImageData(0, 0, 320, 240));
        };
        img.src = URL.createObjectURL(file);
      };
      input.click();
    });

    // --- 音樂引擎初始化 ---
    async function initAudio() {
      if (audioInited) return;
      await Tone.start();

      const filter = new Tone.Filter(1200, "lowpass").toDestination();
      const reverb = new Tone.Reverb({ decay: 4, wet: 0.3 }).connect(filter);
      const chorus = new Tone.Chorus(4, 2.5, 0.5).connect(reverb).start(); 

      // 黑膠雜音
      const vinylNoise = new Tone.Noise("pink").start();
      vinylNoise.volume.value = -48;
      vinylNoise.connect(new Tone.Filter(1000, "bandpass").toDestination());

      // 鋼琴 (Sampler)
      synths.piano = new Tone.Sampler({
        urls: { A1: "A1.mp3", A2: "A2.mp3", C4: "C4.mp3", A4: "A4.mp3" },
        baseUrl: "https://tonejs.github.io/audio/salamander/",
      }).connect(reverb);
      synths.piano.volume.value = -6;

      // 吉他 (物理建模)
      synths.guitar = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "triangle" },
        envelope: { attack: 0.02, decay: 0.8, sustain: 0.1, release: 1.2 }
      }).connect(chorus);
      synths.guitar.volume.value = -12; 
      
      // 鼓組
      synths.kick = new Tone.MembraneSynth({ volume: -20 }).connect(filter);
      synths.snare = new Tone.NoiseSynth({ volume: -35 }).connect(filter);
      synths.hihat = new Tone.MetalSynth({ volume: -40 }).connect(filter);

      // ASMR 生成器
      asmrSynths.rain = new Tone.Noise("white").connect(new Tone.Filter(800, "lowpass").toDestination());
      asmrSynths.rain.volume.value = -99;
      asmrSynths.rain.start();

      asmrSynths.wind = new Tone.AutoFilter("1n", 400, 4).connect(new Tone.Noise("pink").start()).toDestination();
      asmrSynths.wind.volume.value = -99;

      audioInited = true;
    }

    // --- 播放音樂 ---
    playBtn.addEventListener('click', async () => {
      await initAudio();
      Tone.Transport.stop();
      Tone.Transport.cancel();
      
      const f = currentFeatures;
      Tone.Transport.bpm.value = f.bpm;
      const scale = f.mode === 'Major' ? ["C4", "D4", "E4", "G4", "A4"] : ["A3", "C4", "D4", "E4", "G4"];

      // ASMR 切換
      asmrSynths.rain.volume.rampTo(-99, 1);
      asmrSynths.wind.volume.rampTo(-99, 1);
      if (f.brightness < 0.45) {
        asmrSynths.rain.volume.rampTo(-32, 3);
      } else {
        asmrSynths.wind.start();
        asmrSynths.wind.volume.rampTo(-28, 3);
      }

      // 旋律排程 (保留原最滿意版)
      const sequence = [];
      for (let bar = 0; bar < 16; bar++) {
        sequence.push({ time: `${bar}:0:0`, type: "kick" });
        sequence.push({ time: `${bar}:2:0`, type: "kick" });
        sequence.push({ time: `${bar}:1:0`, type: "snare" });
        sequence.push({ time: `${bar}:3:0`, type: "snare" });
        if (bar % 2 === 0) sequence.push({ time: `${bar}:0:0`, type: "piano", notes: [scale[0], scale[2]] });
        sequence.push({ time: `${bar}:0:2`, type: "guitar", note: scale[Math.floor(Math.random()*scale.length)] });
        sequence.push({ time: `${bar}:1:2`, type: "guitar", note: scale[Math.floor(Math.random()*scale.length)] });
        sequence.push({ time: `${bar}:2:1`, type: "guitar", note: scale[Math.floor(Math.random()*scale.length)] });
        sequence.push({ time: `${bar}:3:2`, type: "guitar", note: scale[scale.length-1] });
      }

      new Tone.Part((time, v) => {
        if (v.type === "kick") synths.kick.triggerAttackRelease("C1", "8n", time);
        if (v.type === "snare") synths.snare.triggerAttack(time);
        if (v.type === "piano" && synths.piano.loaded) synths.piano.triggerAttackRelease(v.notes, "1n", time, 0.4);
        if (v.type === "guitar") synths.guitar.triggerAttackRelease(v.note, "2n", time, 0.4);
      }, sequence).start(0);

      Tone.Transport.loop = true;
      Tone.Transport.loopEnd = "16m";
      Tone.Transport.start("+0.1");
      stopBtn.disabled = false;
      playBtn.disabled = true;
    });

    stopBtn.addEventListener('click', () => {
      Tone.Transport.stop();
      if(audioInited) {
        asmrSynths.rain.volume.rampTo(-99, 1);
        asmrSynths.wind.volume.rampTo(-99, 1);
      }
      playBtn.disabled = false;
      stopBtn.disabled = true;
    });
  </script>
</body>
</html>
