<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>拍立得 Lofi 相機實驗室</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tone.js CDN -->
  <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Libre+Barcode+39+Text&display=swap');

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: radial-gradient(circle at top, #fdf6e3 0, #f3e6c7 40%, #e2c69f 100%);
      font-family: 'DM Sans', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: #3b2b28;
    }

    .app-wrapper {
      max-width: 420px;
      width: 100%;
    }

    .app-title {
      text-align: center;
      margin-bottom: 12px;
    }

    .app-title h1 {
      font-size: 22px;
      margin: 0;
      letter-spacing: 0.03em;
    }

    .app-title span {
      font-size: 12px;
      color: #8b6f5a;
    }

    /* 拍立得相機本體 */
    .camera-body {
      position: relative;
      background: linear-gradient(180deg, #f3ede4 0%, #efe5d6 45%, #f7f0df 100%);
      border-radius: 24px;
      padding: 16px 16px 24px;
      box-shadow:
        0 16px 30px rgba(87, 60, 35, .35),
        0 2px 0 #d1b79b;
      border: 1px solid #e0cfb8;
    }

    .camera-top-strip {
      position: absolute;
      top: 10px;
      left: 12px;
      right: 12px;
      height: 12px;
      background: linear-gradient(90deg, #e0b35c, #e4915f, #e27874);
      border-radius: 999px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.4);
    }

    .camera-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
      margin-bottom: 12px;
    }

    .camera-brand {
      font-size: 14px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #7b5b4d;
    }

    .camera-lens {
      position: relative;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #ffffff 0, #c8c5c3 35%, #7e7b78 60%, #2b2927 100%);
      box-shadow:
        0 4px 8px rgba(0,0,0,.35),
        inset 0 0 0 3px rgba(255,255,255,.5);
    }

    .camera-lens::before {
      content: '';
      position: absolute;
      inset: 30%;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.9), rgba(0,0,0,.3));
      opacity: 0.85;
    }

    .camera-lens::after {
      content: '';
      position: absolute;
      top: 12px;
      left: 16px;
      width: 12px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.7);
      filter: blur(1px);
    }

    .camera-viewfinder {
      width: 42px;
      height: 24px;
      border-radius: 6px;
      border: 2px solid #b69983;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.7), #36302b);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.35);
    }

    .camera-main {
      margin-top: 10px;
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 12px;
    }

    /* 拍照區 = 拍立得底片出口 */
    .photo-slot {
      background: #18181b;
      border-radius: 16px;
      padding: 8px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
      position: relative;
      overflow: hidden;
      min-height: 230px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }

    /* 拍立得底片本體 + 出片動畫 */
    .polaroid-frame {
      position: absolute;
      left: 50%;
      transform: translate(-50%, 130%) rotate(-4deg);
      background: #fdfdf9;
      border-radius: 8px;
      padding: 10px 10px 26px;
      box-shadow:
        0 5px 10px rgba(0,0,0,.35),
        0 0 0 1px rgba(0,0,0,.08);
      opacity: 0;
    }

    .polaroid-frame.eject {
      animation: ejectFilm 0.9s ease-out forwards;
    }

    @keyframes ejectFilm {
      0% {
        transform: translate(-50%, 130%) rotate(-4deg);
        opacity: 0;
      }
      40% {
        opacity: 1;
      }
      100% {
        transform: translate(-50%, 0%) rotate(-2deg);
        opacity: 1;
      }
    }

    .polaroid-inner {
      width: 220px;
      max-width: 100%;
      max-height: 220px;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    #preview {
      max-width: 100%;
      max-height: 100%;
      display: block;
    }

    .polaroid-caption {
      margin-top: 6px;
      text-align: center;
      font-size: 11px;
      color: #6b7280;
      font-family: 'Libre Barcode 39 Text', system-ui;
      letter-spacing: .15em;
    }

    /* 控制面板（不顯示數值，只顯示狀態文字） */
    .control-panel {
      padding: 8px;
      border-radius: 16px;
      background: #f4ecde;
      border: 1px solid #e0cfb8;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.5);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 8px;
    }

    .knob-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .shutter-button {
      flex: 1;
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      background: radial-gradient(circle at 30% 20%, #fff7ed, #f97316);
      color: #3b1f0b;
      box-shadow:
        0 4px 0 #b45309,
        0 10px 16px rgba(0,0,0,.35);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .shutter-button:active {
      transform: translateY(2px);
      box-shadow:
        0 2px 0 #92400e,
        0 4px 8px rgba(0,0,0,.3);
    }

    .indicator-light {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fef9c3, #f59e0b);
      border: 2px solid #78350f;
      box-shadow: 0 0 8px rgba(250,204,21,.7);
    }

    .indicator-light.off {
      background: radial-gradient(circle at 30% 20%, #e5e7eb, #9ca3af);
      border-color: #6b7280;
      box-shadow: none;
    }

    .tiny {
      font-size: 11px;
      color: #7b5b4d;
      margin-top: 6px;
      line-height: 1.5;
    }

    /* 底部出片口 + 說明 */
    .camera-footer {
      margin-top: 14px;
      padding-top: 10px;
      border-top: 1px dashed rgba(107, 114, 128, .5);
    }

    .footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #7c6b5a;
    }

    .footer-row span.title {
      font-weight: 600;
      letter-spacing: .08em;
      text-transform: uppercase;
    }

    .footer-row small {
      font-size: 10px;
      color: #9b7356;
    }

    .film-slot {
      margin-top: 10px;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(180deg,#111827,#020617);
      box-shadow:
        inset 0 0 0 1px rgba(148, 163, 184, .6),
        0 4px 8px rgba(15, 23, 42, .6);
    }

    /* 隱藏的 canvas */
    #canvas {
      display: none;
    }

    /* 次要按鈕樣式 */
    .sub-buttons {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .sub-btn {
      flex: 1;
      min-width: 90px;
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 11px;
      font-weight: 500;
      background: #d1c0aa;
      color: #3b2b28;
      box-shadow: 0 2px 0 #b39b7f;
    }

    .sub-btn:disabled {
      opacity: .35;
      box-shadow: none;
      cursor: not-allowed;
    }

    @media (max-width: 480px) {
      .camera-main {
        grid-template-columns: 1fr;
      }
      .polaroid-frame {
        transform: translate(-50%, 130%) rotate(-3deg);
      }
    }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <div class="app-title">
      <h1>拍立得 Lofi 相機實驗室</h1>
      <span>Photo → Mood → Music → Haiku</span>
    </div>

    <div class="camera-body">
      <div class="camera-top-strip"></div>

      <div class="camera-header">
        <div class="camera-viewfinder"></div>
        <div class="camera-brand">CATNIP POLA-LOFI</div>
        <div class="camera-lens"></div>
      </div>

      <div class="camera-main">
        <!-- 左側：拍立得照片 + 出片動畫 -->
        <div class="photo-slot">
          <div class="polaroid-frame" id="polaroidFrame">
            <div class="polaroid-inner">
              <img id="preview" alt="預覽圖片"/>
            </div>
            <div class="polaroid-caption">
              LOFI SNAPSHOT
            </div>
          </div>
        </div>

        <!-- 右側：控制面板（抽象詩句顯示區） -->
        <div class="control-panel">
          <div>
            <div class="knob-row">
              <button id="fileSelectProxy" class="shutter-button">LOAD / SHOOT</button>
              <div id="indicator" class="indicator-light off"></div>
            </div>
            <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none;">
            <div class="tiny" id="analysisText">
              載入或拍一張照片，拍立得就會吐出一段 Lofi 音樂與一首短短的俳句。
            </div>
          </div>

          <div>
            <div class="sub-buttons">
              <button id="initAudioBtn" class="sub-btn">啟動音樂引擎</button>
              <button id="playBtn" class="sub-btn" disabled>播放 Lofi</button>
              <button id="stopBtn" class="sub-btn" disabled>停止</button>
            </div>
          </div>
        </div>
      </div>

      <div class="camera-footer">
        <div class="footer-row">
          <span class="title">INSTANT COLOR-SCORE</span>
          <small>讓音樂紀錄每個時刻的心情。</small>
        </div>
        <div class="film-slot"></div>
      </div>

      <canvas id="canvas"></canvas>
    </div>
  </div>

  <script>
    // --------------- 照片 → 數值 ---------------

    const fileInput = document.getElementById('fileInput');
    const fileSelectProxy = document.getElementById('fileSelectProxy');
    const preview = document.getElementById('preview');
    const canvas = document.getElementById('canvas');
    const indicator = document.getElementById('indicator');
    const polaroidFrame = document.getElementById('polaroidFrame');

    const analysisText = document.getElementById('analysisText');

    let currentFeatures = null; // {brightness, saturation, hue, bpm, keyCenter, density}

    fileSelectProxy.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        preview.src = ev.target.result;
        preview.onload = () => analyze(preview);
      };
      reader.readAsDataURL(file);
    });

    function analyze(img) {
      const maxWidth = 400;
      const scale = Math.min(1, maxWidth / img.naturalWidth);
      const w = img.naturalWidth * scale;
      const h = img.naturalHeight * scale;

      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);

      const imageData = ctx.getImageData(0, 0, w, h);
      const data = imageData.data;

      let totalL = 0;
      let totalS = 0;
      let totalHueX = 0;
      let totalHueY = 0;
      let count = 0;

      for (let i = 0; i < data.length; i += 4 * 4) {
        const r = data[i] / 255;
        const g = data[i+1] / 255;
        const b = data[i+2] / 255;

        const L = (r + g + b) / 3;

        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        const delta = max - min;
        let h = 0;
        let s = 0;
        const l = (max + min) / 2;

        if (delta !== 0) {
          s = delta / (1 - Math.abs(2*l - 1));
          if (max === r) {
            h = 60 * (((g - b) / delta) % 6);
          } else if (max === g) {
            h = 60 * (((b - r) / delta) + 2);
          } else {
            h = 60 * (((r - g) / delta) + 4);
          }
        }
        if (h < 0) h += 360;

        totalL += L;
        totalS += s;
        const rad = h * Math.PI / 180;
        totalHueX += Math.cos(rad);
        totalHueY += Math.sin(rad);
        count++;
      }

      const avgL = totalL / count;      // 0~1
      const avgS = totalS / count;      // 0~1
      const avgHueRad = Math.atan2(totalHueY / count, totalHueX / count);
      let avgHue = avgHueRad * 180 / Math.PI;
      if (avgHue < 0) avgHue += 360;

      const L100 = avgL * 100;
      const S100 = avgS * 100;

      const mapping = mapFeaturesToMusic(L100, S100, avgHue);
      currentFeatures = {
        brightness: L100,
        saturation: S100,
        hue: avgHue,
        ...mapping
      };

      indicator.classList.remove('off');
      runFilmEjectAnimation();
      updateAnalysisText(currentFeatures);
    }

    // 抽象俳句產生器（不提顏色、不提具象場景）
    function updateAnalysisText(f) {
      if (!f) {
        analysisText.textContent = "載入或拍一張照片，拍立得就會吐出一段 Lofi 音樂與一首短短的俳句。";
        return;
      }

      const A = [
        "靜靜升起",
        "緩緩沉下",
        "無聲散開",
        "心事未說",
        "輕念飄動",
        "柔意回旋"
      ];

      const B = [
        "時間變慢",
        "呼吸放鬆",
        "節奏鬆開",
        "片刻拉長",
        "世界變輕",
        "思緒解開"
      ];

      const C = [
        "落在內層深處",
        "像未完成的句子",
        "一切尚未命名",
        "保持著溫柔",
        "無需去往何處",
        "在靜處延伸"
      ];

      // brightness 決定 A 的索引（由亮到暗的心情）
      const aIndex = Math.min(
        A.length - 1,
        Math.floor((f.brightness / 100) * A.length)
      );

      // density 決定 B 的索引（節奏鬆緊）
      let bIndexBase = 0;
      if (f.density === "mid") bIndexBase = 2;
      else if (f.density === "high") bIndexBase = 4;
      const bIndex = Math.min(B.length - 1, bIndexBase);

      // hue 只是用來做「變化來源」，不直接描述顏色
      const cIndex = Math.floor((f.hue / 360) * C.length) % C.length;

      const line1 = A[aIndex];
      const line2 = B[bIndex];
      const line3 = C[cIndex];

      analysisText.innerHTML = `
        ${line1}<br>
        ${line2}<br>
        ${line3}
      `;
    }

    function mapFeaturesToMusic(brightness, saturation, hue) {
      const baseBpm = 60;
      const extra = (brightness / 100) * 30;
      const bpm = Math.round(baseBpm + extra);

      let keyCenter = "A3";
      if (hue < 30 || hue >= 330) keyCenter = "A3";
      else if (hue < 90)         keyCenter = "D3";
      else if (hue < 150)        keyCenter = "E3";
      else if (hue < 210)        keyCenter = "F#3";
      else if (hue < 270)        keyCenter = "G3";
      else                       keyCenter = "C3";

      const energy = (brightness + saturation) / 2;
      let density = "low";
      if (energy > 70) density = "high";
      else if (energy > 45) density = "mid";

      return { bpm, keyCenter, density };
    }

    // 出片動畫 + 拍立得聲音
    function runFilmEjectAnimation() {
      polaroidFrame.classList.remove('eject');
      // 強制重排讓動畫可以重新播放
      void polaroidFrame.offsetWidth;
      polaroidFrame.classList.add('eject');
      playShutterSound();
    }

    // --------------- Tone.js Lofi 音樂引擎 & 拍立得聲音 ---------------

    const initAudioBtn = document.getElementById('initAudioBtn');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');

    let audioInited = false;
    let chordSynth, leadSynth, kick, snare, hihat, reverb, filter, sidechainComp;
    let shutterSynth, shutterNoise;
    let chordPart, leadPart, kickPart, snarePart, hatPart;

    initAudioBtn.addEventListener('click', async () => {
      await Tone.start();
      if (!audioInited) {
        setupToneGraph();
        audioInited = true;
      }
      initAudioBtn.textContent = "引擎已啟動";
      initAudioBtn.disabled = true;
      playBtn.disabled = false;
      stopBtn.disabled = false;
    });

    playBtn.addEventListener('click', () => {
      if (!currentFeatures) {
        alert("請先載入或拍攝一張照片，讓相機分析並吐出底片！");
        return;
      }
      startMusic(currentFeatures);
    });

    stopBtn.addEventListener('click', () => {
      Tone.Transport.stop();
    });

    function setupToneGraph() {
      filter = new Tone.Filter(800, "lowpass", -12);
      reverb = new Tone.Reverb({
        decay: 4,
        wet: 0.3
      }).toDestination();

      sidechainComp = new Tone.Compressor({
        threshold: -24,
        ratio: 3,
        attack: 0.01,
        release: 0.3
      }).connect(reverb);

      chordSynth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "triangle" },
        envelope: { attack: 0.05, decay: 0.2, sustain: 0.5, release: 1.5 }
      }).connect(filter);

      leadSynth = new Tone.Synth({
        oscillator: { type: "sine" },
        envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 0.8 }
      }).connect(filter);

      filter.connect(sidechainComp);

      kick = new Tone.MembraneSynth({
        pitchDecay: 0.02,
        octaves: 4,
        oscillator: { type: "sine" },
        envelope: { attack: 0.001, decay: 0.3, sustain: 0.0, release: 0.3 }
      }).connect(reverb);

      snare = new Tone.NoiseSynth({
        noise: { type: "pink" },
        envelope: { attack: 0.001, decay: 0.25, sustain: 0 }
      }).connect(reverb);

      hihat = new Tone.NoiseSynth({
        noise: { type: "white" },
        envelope: { attack: 0.001, decay: 0.08, sustain: 0 }
      }).connect(reverb);

      // 拍立得「卡嚓＋機器運轉」聲
      shutterSynth = new Tone.MembraneSynth({
        pitchDecay: 0.04,
        octaves: 6,
        oscillator: { type: "sine" },
        envelope: { attack: 0.001, decay: 0.18, sustain: 0.0, release: 0.2 }
      }).connect(reverb);

      shutterNoise = new Tone.NoiseSynth({
        noise: { type: "white" },
        envelope: { attack: 0.005, decay: 0.25, sustain: 0.0, release: 0.1 }
      }).connect(reverb);

      Tone.Destination.volume.value = -8;
    }

    function playShutterSound() {
      if (!audioInited) return; // 還沒啟動音訊時就靜默，不強制
      const now = Tone.now();
      // 機械快門「卡嚓」
      shutterSynth.triggerAttackRelease("C3", "16n", now);
      // 短暫的機器運轉感
      shutterNoise.triggerAttackRelease("8n", now + 0.03);
    }

    function getMinor7Chord(rootNote) {
      const root = Tone.Frequency(rootNote);
      const minor3rd = root.transpose(3);
      const fifth = root.transpose(7);
      const minor7th = root.transpose(10);
      return [root, minor3rd, fifth, minor7th].map(f => f.toNote());
    }

    function buildChordProgression(keyCenter) {
      const root = Tone.Frequency(keyCenter);
      const iv = root.transpose(5);
      const bVII = root.transpose(10);
      const progRoots = [root, iv, bVII, root];
      return progRoots.map(f => getMinor7Chord(f.toNote()));
    }

    function buildLeadNotes(keyCenter, brightness) {
      const base = Tone.Frequency(keyCenter).transpose(brightness > 55 ? 12 : 5);
      const scaleIntervals = [0, 2, 3, 5, 7, 10];
      const pattern = [0, 2, 4, 1, 3, 5, 2, 0];
      return pattern.map(i => base.transpose(scaleIntervals[i]).toNote());
    }

    function startMusic(features) {
      if (chordPart) chordPart.dispose();
      if (leadPart) leadPart.dispose();
      if (kickPart) kickPart.dispose();
      if (snarePart) snarePart.dispose();
      if (hatPart) hatPart.dispose();

      Tone.Transport.bpm.value = features.bpm;

      const chords = buildChordProgression(features.keyCenter);
      const leadNotes = buildLeadNotes(features.keyCenter, features.brightness);

      chordPart = new Tone.Part((time, value) => {
        chordSynth.triggerAttackRelease(value, "2n", time);
      }, [
        ["0:0", chords[0]],
        ["0:2", chords[0]],
        ["1:0", chords[1]],
        ["1:2", chords[1]],
        ["2:0", chords[2]],
        ["2:2", chords[2]],
        ["3:0", chords[3]],
        ["3:2", chords[3]]
      ]);
      chordPart.loop = true;
      chordPart.loopEnd = "4m";
      chordPart.start(0);

      leadPart = new Tone.Part((time, note) => {
        leadSynth.triggerAttackRelease(note, "8n", time);
      }, leadNotes.map((note, i) => [ `0:0:${i}`, note ]));
      leadPart.loop = true;
      leadPart.loopEnd = "2m";
      leadPart.start("0:0:2");

      const dense = features.density === "high";
      const mid = features.density === "mid";

      const kickEvents = [
        "0:0", "0:2",
        "1:0", "1:2",
        "2:0", "2:2",
        "3:0", "3:2"
      ];
      kickPart = new Tone.Part((time) => {
        kick.triggerAttackRelease("C2", "8n", time);
        sidechainComp.triggerAttackRelease(0.2, time);
      }, kickEvents);

      if (dense || mid) {
        kickPart.add("1:3", null);
        kickPart.add("3:3", null);
      }

      kickPart.loop = true;
      kickPart.loopEnd = "4m";
      kickPart.start(0);

      snarePart = new Tone.Part((time) => {
        snare.triggerAttackRelease("16n", time);
      }, [
        "0:2", "1:2", "2:2", "3:2"
      ]);
      snarePart.loop = true;
      snarePart.loopEnd = "4m";
      snarePart.start(0);

      const hatEvents = [];
      if (features.density === "low") {
        ["0:0","0:2","1:0","1:2","2:0","2:2","3:0","3:2"].forEach(t => hatEvents.push(t));
      } else if (features.density === "mid") {
        for (let m=0; m<4; m++) {
          ["0","1","2","3"].forEach(beat => {
            hatEvents.push(`${m}:${beat}`);
          });
        }
      } else {
        for (let m=0; m<4; m++) {
          ["0","0:2","1","1:2","2","2:2","3","3:2"].forEach(sub => {
            hatEvents.push(`${m}:${sub}`);
          });
        }
      }

      hatPart = new Tone.Part((time) => {
        hihat.triggerAttackRelease("8n", time, 0.4);
      }, hatEvents);
      hatPart.loop = true;
      hatPart.loopEnd = "4m";
      hatPart.start(0);

      const volume = Tone.Destination.volume;
      volume.rampTo(
        Tone.gainToDb((features.brightness/100) * 0.5 + 0.3),
        0.2
      );

      Tone.Transport.start("+0.1");
    }
  </script>
</body>
</html>
