<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Music Camera - Original UI with Vibe Lo-Fi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Libre+Barcode+39+Text&family=Noto+Serif+TC:wght@500&display=swap');
    * { box-sizing: border-box; }

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(#d7d7d7, #bdbdbd);
      font-family: 'DM Sans', sans-serif;
    }

    /* ====== 外觀（保持你目前版本）====== */
    .polaroid-camera{
      width: 430px;
      max-width: 92vw;
      background: linear-gradient(180deg, #dcdcdc, #bfbfbf);
      border-radius: 22px;
      padding: 18px;
      box-shadow: 0 14px 32px rgba(0,0,0,.25);
      border: 1px solid rgba(0,0,0,.15);
      position: relative;
      overflow: hidden;
    }

    .camera-top{
      height: 64px;
      border-radius: 16px;
      background: linear-gradient(180deg, #b07a4d, #7f5635);
      position: relative;
      border: 1px solid rgba(0,0,0,.18);
      margin-bottom: 12px;
    }
    .camera-top:before{
      content:"";
      position:absolute;
      inset: 12px 16px;
      border-radius: 12px;
      border: 2px solid rgba(255,255,255,.22);
    }
    .camera-top:after{
      content:"";
      position:absolute;
      inset: 22px 26px;
      border-radius: 10px;
      border: 1px dashed rgba(255,235,200,.75);
    }

    .camera-header{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 6px 4px 14px;
    }

    .camera-light{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #ffb8ad, #d14a3c);
      border: 2px solid rgba(0,0,0,.25);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
    }

    .camera-title{
      flex: 1;
      text-align:center;
      font-weight: 800;
      letter-spacing: .22em;
      color: rgba(0,0,0,.6);
      user-select:none;
    }

    .camera-flash{
      width: 56px;
      height: 22px;
      border-radius: 10px;
      background:
        repeating-linear-gradient(90deg, rgba(255,255,255,.55) 0, rgba(255,255,255,.55) 2px, rgba(255,255,255,.22) 2px, rgba(255,255,255,.22) 5px),
        linear-gradient(180deg, rgba(255,255,255,.65), rgba(0,0,0,.12));
      border: 1px solid rgba(0,0,0,.22);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
    }

    .camera-body-row{
      display:flex;
      gap: 14px;
      align-items: stretch;
    }

    .left-panel{
      flex: 1;
      background: linear-gradient(180deg, #14161a, #0a0b0d);
      border-radius: 18px;
      padding: 14px;
      color: #e9ecef;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.45);
    }

    .mode-switch-group{
      display:flex;
      gap: 10px;
      margin-bottom: 12px;
    }
    .mode-btn{
      flex:1;
      padding: 10px 0;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: rgba(233,236,239,.7);
      font-weight: 800;
      letter-spacing: .12em;
      cursor:pointer;
    }
    .mode-btn.active{
      background: rgba(255,255,255,.18);
      color: rgba(255,255,255,.95);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.35);
    }

    .control-center{
      display:flex;
      flex-direction: column;
      gap: 10px;
    }

    .main-btn{
      width: 100%;
      padding: 16px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: linear-gradient(180deg, #f7f7f7, #dcdcdc);
      color: #111827;
      font-weight: 900;
      font-size: 24px;
      letter-spacing: .12em;
      text-transform: uppercase;
      box-shadow: 0 10px 20px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.6);
    }
    .main-btn:active{ transform: translateY(1px); }

    .sub-btn-group{
      display:flex;
      gap: 10px;
    }
    .sub-btn{
      flex:1;
      padding: 14px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(233,236,239,.65);
      font-weight: 900;
      font-size: 20px;
      letter-spacing: .14em;
      text-transform: uppercase;
      cursor:pointer;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.55);
    }
    .sub-btn:disabled{
      opacity: .35;
      cursor:not-allowed;
    }

    .analysis-text{
      margin-top: 6px;
      padding-top: 12px;
      border-top: 1px dashed rgba(233,236,239,.22);
      font-family: 'Noto Serif TC', serif;
      font-size: 18px;
      line-height: 1.6;
      color: rgba(233,236,239,.92);
    }

    .right-panel{
      width: 170px;
      background: linear-gradient(180deg, rgba(0,0,0,.08), rgba(255,255,255,.05));
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,.16);
      position: relative;
      overflow: hidden;
      min-height: 360px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
    }
    .right-panel:before{
      content:"";
      position:absolute;
      inset: 12px;
      border-radius: 14px;
      background: linear-gradient(180deg, #c3c8cd, #9fa6ad);
      border: 1px solid rgba(0,0,0,.15);
      box-shadow: inset 0 10px 30px rgba(0,0,0,.12);
    }

    .film-slot{
      position:absolute;
      left: 18px;
      right: 18px;
      bottom: 20px;
      height: 16px;
      border-radius: 999px;
      background: #0b0c0e;
      box-shadow: inset 0 2px 10px rgba(0,0,0,.75);
      border: 1px solid rgba(255,255,255,.06);
      z-index: 6;
    }

    .polaroid-frame{
      position:absolute;
      left: 50%;
      bottom: 10px;
      transform: translate(-50%, 140%);
      width: 150px;
      background: #fdfdf9;
      border-radius: 10px;
      padding: 10px 10px 28px;
      box-shadow: 0 18px 30px rgba(0,0,0,.35);
      opacity: 0;
      z-index: 5;
      --developDur: 2.5s;
    }
    .polaroid-frame.eject { animation: ejectFilm 0.9s ease-out forwards; }
    @keyframes ejectFilm {
      0%   { transform: translate(-50%, 140%); opacity: 0; }
      100% { transform: translate(-50%, 18%);  opacity: 1; }
    }

    .polaroid-inner{
      width:100%;
      aspect-ratio: 1;
      background: #0b0c0f;
      border-radius: 8px;
      overflow:hidden;
      position: relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .film-overlay { position:absolute; inset:0; pointer-events:none; z-index:10; }
    .grain { position:absolute; inset:0; background-image:url("https://www.transparenttextures.com/patterns/stardust.png"); opacity:.2; mix-blend-mode: overlay; }
    .light-leak { position:absolute; inset:0; background: radial-gradient(circle at 0% 50%, rgba(255, 80, 0, 0.4) 0%, transparent 60%), radial-gradient(circle at 100% 10%, rgba(255, 150, 50, 0.2) 0%, transparent 50%); mix-blend-mode: screen; filter: blur(10px); }

    /* 照片完整呈現（不裁切） */
    #preview{
      width:100%;
      height:100%;
      object-fit: contain;
      background:#0b0c0f;
      opacity:0;
      filter: brightness(0.05) contrast(0.6) saturate(0.1);
      transition: opacity var(--developDur) linear, filter var(--developDur) linear;
    }
    #preview.develop{
      opacity:1;
      filter: sepia(0.3) contrast(1.2) brightness(1.05) saturate(1.1);
    }

    /* ====== 相機 overlay（保持）====== */
    #cameraOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
    }
    #videoPreview { width: 100%; max-width: 420px; aspect-ratio: 1; object-fit: cover; }
    .camera-controls { margin-top: 30px; display: flex; gap: 30px; align-items: center; }
    .snap-btn { width: 70px; height: 70px; border-radius: 50%; background: #fff; border: 6px solid #444; }
    .overlay-close { position: absolute; top: 20px; right: 20px; color: #fff; font-size: 30px; background: none; border: none; }
    .album-btn { background: #444; color: #fff; border: none; padding: 10px 20px; border-radius: 20px; }
    #canvas { display: none; }
  </style>
</head>

<body>
  <div class="polaroid-camera">
    <div class="camera-top"></div>

    <div class="camera-header">
      <div class="camera-light"></div>
      <div class="camera-title">MUSIC CAMERA</div>
      <div class="camera-flash"></div>
    </div>

    <div class="camera-body-row">
      <div class="left-panel">
        <div class="control-center">
          <div class="mode-switch-group">
            <button class="mode-btn active" id="lofiModeBtn">LO-FI</button>
            <button class="mode-btn" id="jazzModeBtn">JAZZ</button>
          </div>

          <button class="main-btn" id="openCamBtn">SHOOT / LOAD</button>

          <div class="sub-btn-group">
            <button class="sub-btn" id="playBtn" disabled>PLAY</button>
            <button class="sub-btn" id="stopBtn" disabled>STOP</button>
          </div>

          <div class="analysis-text" id="analysisText">每個回憶，都是一段獨一無二的旋律</div>
        </div>
      </div>

      <div class="right-panel">
        <div class="polaroid-frame" id="polaroidFrame">
          <div class="polaroid-inner">
            <div class="film-overlay"><div class="grain"></div><div class="light-leak"></div></div>
            <img id="preview" alt="Snapshot"/>
          </div>
        </div>
        <div class="film-slot"></div>
      </div>
    </div>
  </div>

  <div id="cameraOverlay">
    <button class="overlay-close" id="closeOverlay">✕</button>
    <video id="videoPreview" autoplay playsinline></video>
    <div class="camera-controls">
      <button class="album-btn" id="albumBtn">相簿</button>
      <button class="snap-btn" id="snapBtn"></button>
      <div style="width:60px;"></div>
    </div>
  </div>

  <input type="file" id="fileInput" accept="image/*" style="display:none;">
  <canvas id="canvas"></canvas>
  <audio id="shutterSfx" src="polaroid-shutter.mp3"></audio>

  <script>
    const openCamBtn = document.getElementById('openCamBtn');
    const cameraOverlay = document.getElementById('cameraOverlay');
    const videoPreview = document.getElementById('videoPreview');
    const snapBtn = document.getElementById('snapBtn');
    const albumBtn = document.getElementById('albumBtn');
    const fileInput = document.getElementById('fileInput');
    const closeOverlay = document.getElementById('closeOverlay');
    const preview = document.getElementById('preview');
    const polaroidFrame = document.getElementById('polaroidFrame');
    const analysisText = document.getElementById('analysisText');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const shutterSfx = document.getElementById('shutterSfx');
    const canvas = document.getElementById('canvas');

    const lofiModeBtn = document.getElementById('lofiModeBtn');
    const jazzModeBtn = document.getElementById('jazzModeBtn');

    let stream = null;
    let audioInited = false;
    let currentFeatures = null;
    let synths = {};
    let musicMode = "lofi";

    const tagMatrix = {
      'Energetic': { text: "充滿活力的節奏", bpmAdd: 10, density: 0.85, reverb: 0.2 },
      'Gentle': { text: "溫柔舒緩的氛圍", bpmAdd: -6, density: 0.45, reverb: 0.55 },
      'Bright': { text: "明亮清新的光感", bpmAdd: 6, density: 0.6, reverb: 0.35 },
      'Dreamy': { text: "如夢似幻的泡影", bpmAdd: -8, density: 0.4, reverb: 0.7 },
      'Warm': { text: "溫暖的懷舊色調", bpmAdd: -4, density: 0.55, reverb: 0.45 },
      'Cool': { text: "冷冽的距離感", bpmAdd: -2, density: 0.5, reverb: 0.6 },
      'Soft': { text: "柔軟的呼吸", bpmAdd: -10, density: 0.35, reverb: 0.65 },
      'Calm': { text: "平靜的水面", bpmAdd: -12, density: 0.3, reverb: 0.7 },
      'Mysterious': { text: "隱約的暗流", bpmAdd: -8, density: 0.5, reverb: 0.75 },
      'Melancholy': { text: "淡淡的憂傷", bpmAdd: -10, density: 0.4, reverb: 0.8 }
    };

    lofiModeBtn.addEventListener("click", () => {
      musicMode = "lofi";
      lofiModeBtn.classList.add("active");
      jazzModeBtn.classList.remove("active");
    });
    jazzModeBtn.addEventListener("click", () => {
      musicMode = "jazz";
      jazzModeBtn.classList.add("active");
      lofiModeBtn.classList.remove("active");
    });

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        videoPreview.srcObject = stream;
        cameraOverlay.style.display = 'flex';
      } catch (e) {
        fileInput.click();
      }
    }
    function stopCamera() {
      if (stream) stream.getTracks().forEach(t => t.stop());
      cameraOverlay.style.display = 'none';
    }
    openCamBtn.addEventListener('click', startCamera);
    closeOverlay.addEventListener('click', stopCamera);
    albumBtn.addEventListener('click', () => fileInput.click());

    snapBtn.addEventListener('click', () => {
      const ctx = canvas.getContext('2d');
      canvas.width = videoPreview.videoWidth;
      canvas.height = videoPreview.videoHeight;
      ctx.drawImage(videoPreview, 0, 0);
      preview.src = canvas.toDataURL('image/jpeg');
      stopCamera();
      analyzePhoto();
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => { preview.src = ev.target.result; stopCamera(); analyzePhoto(); };
      reader.readAsDataURL(file);
    });

    function analyzePhoto() {
      preview.onload = () => {
        const ctx = canvas.getContext('2d');
        canvas.width = 10; canvas.height = 10;
        ctx.drawImage(preview, 0, 0, 10, 10);
        const data = ctx.getImageData(0, 0, 10, 10).data;
        let r=0, g=0, b=0, bri=0;
        for(let i=0; i<data.length; i+=4){ r+=data[i]; g+=data[i+1]; b+=data[i+2]; bri+=(data[i]+data[i+1]+data[i+2])/3; }

        const tags = Object.keys(tagMatrix);
        let tagIndex = (r + g + b) % tags.length;
        if (bri > 200) tagIndex = 2;
        if (bri < 50) tagIndex = 8;
        if (b > r + 50) tagIndex = 9;

        const selectedTag = tags[tagIndex];

        currentFeatures = {
          tagInfo: tagMatrix[selectedTag],
          mode: (bri/100) > 125 ? 'Major' : 'Minor',
          seed: (r + g + b),
          bpm: 90 + tagMatrix[selectedTag].bpmAdd
        };

        analysisText.innerHTML = `讓音樂完整回憶`;
        triggerEject();
      };
    }

    function triggerEject() {
      polaroidFrame.classList.remove('eject');
      void polaroidFrame.offsetWidth;
      polaroidFrame.classList.add('eject');

      preview.classList.remove('develop');

      shutterSfx.currentTime = 0;
      shutterSfx.play();

      setTimeout(() => preview.classList.add('develop'), 50);

      shutterSfx.onended = () => {
        playBtn.disabled = false;
      };
    }

    async function initAudio() {
      if (audioInited) return;
      await Tone.start();
      const filter = new Tone.Filter(1200, "lowpass").toDestination();
      synths.reverb = new Tone.Reverb({ decay: 4, wet: 0.3 }).connect(filter);
      const chorus = new Tone.Chorus(4, 2.5, 0.5).connect(synths.reverb).start();

      synths.piano = new Tone.Sampler({
        urls: { A1: "A1.mp3", C4: "C4.mp3" },
        baseUrl: "https://tonejs.github.io/audio/salamander/",
      }).connect(synths.reverb);

      synths.guitar = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "triangle" },
        envelope: { attack: 0.02, decay: 0.8, sustain: 0.1, release: 1.2 }
      }).connect(chorus);

      synths.bass = new Tone.MonoSynth({ oscillator: { type: "sine" } }).toDestination();
      synths.kick = new Tone.MembraneSynth({ volume: -20 }).connect(filter);
      synths.snare = new Tone.NoiseSynth({ volume: -35 }).connect(filter);

      audioInited = true;
    }

    playBtn.addEventListener('click', async () => {
      await initAudio();
      Tone.Transport.stop(); Tone.Transport.cancel();

      const f = currentFeatures;
      const info = f.tagInfo;
      Tone.Transport.bpm.value = f.bpm;
      synths.reverb.wet.value = info.reverb;

      const scale = f.mode === 'Major' ? ["C4", "D4", "E4", "G4", "A4"] : ["A3", "C4", "D4", "E4", "G4"];
      const jazzScale = ["C3", "Eb3", "F3", "Gb3", "G3", "Bb3", "C4"];

      // ===== LO-FI 2.1：更大變化（同一張照片 → 同一首）=====
      // 只在 LO-FI 模式建立一次：用 seed 做可重現的變化，讓不同照片差異更大
      const lofiCtx = (() => {
        if (musicMode === 'jazz') return null;

        const seed0 = (f.seed >>> 0) ^ ((f.bpm & 255) << 8) ^ (Math.floor(info.density*1000) << 1);

        // deterministic rand in [0,1)
        const rand01 = (n) => {
          let x = (seed0 ^ (n * 1664525)) >>> 0;
          x ^= x << 13; x >>>= 0;
          x ^= x >>> 17; x >>>= 0;
          x ^= x << 5;  x >>>= 0;
          return x / 4294967296;
        };

        const midiToNote = (m) => Tone.Frequency(m, "midi").toNote();

        // key / scale type（用 seed 決定）
        const keyMidi = 48 + (seed0 % 12); // C3=48
        const scaleTypes = [
          { name: "maj",  iv: [0,2,4,5,7,9,11] },   // Ionian
          { name: "min",  iv: [0,2,3,5,7,8,10] },   // Aeolian
          { name: "dor",  iv: [0,2,3,5,7,9,10] },   // Dorian（cozy 常用）
          { name: "mix",  iv: [0,2,4,5,7,9,10] },   // Mixolydian
          { name: "hm",   iv: [0,2,3,5,7,8,11] },   // Harmonic minor
          { name: "pent", iv: [0,3,5,7,10] }        // Minor pentatonic
        ];
        const pick = scaleTypes[(seed0 >>> 4) % scaleTypes.length];
        const iv = pick.iv;

        const scale1 = iv.map(semi => keyMidi + semi);          // ~C3
        const scale2 = iv.map(semi => keyMidi + 12 + semi);     // ~C4
        const scale3 = iv.map(semi => keyMidi + 24 + semi);     // ~C5
        const melodyPool = [...scale2, ...scale3];
        const bassPool = scale1;

        // progression templates
        const progMaj = [
          [1,6,4,5],
          [1,5,6,4],
          [6,4,1,5],
          [2,5,1,6],
        ];
        const progMin = [
          [1,6,3,7],
          [1,4,7,3],
          [6,7,1,5],
          [4,1,6,7],
        ];
        const isMinorFamily = (pick.name === "min" || pick.name === "dor" || pick.name === "hm" || pick.name === "pent");
        const prog = (isMinorFamily ? progMin : progMaj)[(seed0 >>> 9) % 4];

        const degToIdx = (deg) => (deg - 1) % scale2.length;

        function chordNotesForDegree(deg, useHigh, bar){
          const base = useHigh ? scale3 : scale2;
          const i0 = degToIdx(deg);
          const i2 = (i0 + 2) % base.length;
          const i4 = (i0 + 4) % base.length;
          const i6 = (i0 + 6) % base.length;

          const use7 = rand01(bar*13 + 7) < 0.55;
          const chord = [base[i0], base[i2], base[i4]];
          if (use7) {
            let n7 = base[i6];
            if (n7 < base[i4]) n7 += 12;
            chord.push(n7);
          }
          chord.sort((a,b)=>a-b);
          return chord.map(midiToNote);
        }

        function melodyNote(bar, step){
          const idx0 = ((seed0 >>> 2) + bar*3 + step*5) % melodyPool.length;
          let idx = idx0;
          const r = rand01(bar*97 + step*31);
          if (r < 0.65) idx += (rand01(bar*101 + step*7) < 0.5 ? -1 : 1);
          else idx += (rand01(bar*103 + step*11) < 0.5 ? -2 : 2);
          idx = (idx + melodyPool.length) % melodyPool.length;
          return midiToNote(melodyPool[idx]);
        }

        function bassNotesForDegree(deg, bar){
          const i = degToIdx(deg);
          const root = bassPool[i] - 12;
          const fifth = bassPool[(i + 4) % bassPool.length];
          const fifthAdj = (fifth < bassPool[i] ? fifth + 12 : fifth) - 12;
          const useFifth = rand01(bar*19 + 3) < 0.55;
          return [midiToNote(root), midiToNote(useFifth ? fifthAdj : root)];
        }

        return { seed0, pick, prog, chordNotesForDegree, melodyNote, bassNotesForDegree, rand01 };
      })();

      Tone.Transport.swing = musicMode === 'jazz' ? 0.4 : 0;
      const sequence = [];

      for (let bar = 0; bar < 16; bar++) {
        if (bar % 2 === 0 || info.density > 0.6) {
          sequence.push({ time: `${bar}:0:0`, type: "kick" });
          sequence.push({ time: `${bar}:2:0`, type: "kick" });
        }
        sequence.push({ time: `${bar}:1:0`, type: "snare" });
        sequence.push({ time: `${bar}:3:0`, type: "snare" });

        if (musicMode === 'jazz') {
          for (let beat = 0; beat < 4; beat++) {
            if (Math.random() < info.density + 0.2) {
              const note = jazzScale[(f.seed + bar + beat) % jazzScale.length].replace('4','2').replace('3','2');
              sequence.push({ time: `${bar}:${beat}:0`, type: "bass", note: note });
            }
          }
          if (bar % 4 === 0) sequence.push({ time: `${bar}:0:2`, type: "piano", notes: [jazzScale[0], jazzScale[2], jazzScale[4]] });
        } else {
          // LO-FI：用照片 seed 產生「可重現」且差異更大的和聲/低音/旋律
          const ctx = lofiCtx;
          const dens = info.density;

          // 額外 ghost（基底 kick/snare 已在外面排好）
          if (dens > 0.75 && (ctx.seed0 + bar) % 3 === 0) sequence.push({ time: `${bar}:3:2`, type: "kick" });
          if (dens > 0.7  && (ctx.seed0 + bar) % 4 === 1) sequence.push({ time: `${bar}:1:2`, type: "snare" });

          // chord progression（4 bars per chord）
          const chordDeg = ctx.prog[Math.floor(bar / 4) % 4];

          const useHigh = (f.bpm >= 96) ? true : ((ctx.seed0 >>> 7) % 2 === 0);
          const chordHold = dens < 0.55 ? "2n" : "1n";
          const chordVel  = 0.30 + dens * 0.22;

          const chord = ctx.chordNotesForDegree(chordDeg, useHigh, bar);
          sequence.push({ time: `${bar}:0:0`, type: "piano", notes: chord, dur: chordHold, vel: chordVel });

          // bass（根音 + 2 拍走向）
          const [bass0, bass2] = ctx.bassNotesForDegree(chordDeg, bar);
          sequence.push({ time: `${bar}:0:0`, type: "bass", note: bass0 });
          if (dens > 0.45) sequence.push({ time: `${bar}:2:0`, type: "bass", note: bass2 });

          // melody（8th notes with rests；密度越低留白越多）
          const prob = (0.35 + (0.85 - 0.35) * dens);
          const steps = [0,2,0,2,0,2,0,2];
          for (let s = 0; s < 8; s++) {
            const beat = Math.floor(s / 2);
            const sixteenth = steps[s];

            const r = ctx.rand01(bar * 131 + s * 17);
            if (r < prob) {
              const note = ctx.melodyNote(bar, s);

              // 少量裝飾音（更像 cozy / dreamy，但不亂）
              const doGrace = dens > 0.6 && ctx.rand01(bar * 71 + s * 29) < 0.18;
              if (doGrace) {
                const gUp = (ctx.rand01(bar * 73 + s * 31) < 0.5) ? 1 : -1;
                const grace = Tone.Frequency(note).transpose(gUp).toNote();
                sequence.push({ time: `${bar}:${beat}:${sixteenth}`, type: "guitar", note: grace, dur: "16n", vel: 0.18 });
                sequence.push({ time: `${bar}:${beat}:${sixteenth+1}`, type: "guitar", note: note,  dur: "8n",  vel: 0.22 + dens * 0.16 });
              } else {
                sequence.push({ time: `${bar}:${beat}:${sixteenth}`, type: "guitar", note: note, dur: "8n", vel: 0.22 + dens * 0.16 });
              }
            }
          }
        }
      }

      new Tone.Part((time, v) => {
        if (v.type === "kick") synths.kick.triggerAttackRelease("C1", "8n", time);
        if (v.type === "snare") synths.snare.triggerAttack(time);
        if (v.type === "bass") synths.bass.triggerAttackRelease(v.note, "4n", time, 0.4);
        if (v.type === "piano" && synths.piano.loaded) synths.piano.triggerAttackRelease(v.notes, v.dur || "1n", time, v.vel ?? 0.4);
        if (v.type === "guitar") synths.guitar.triggerAttackRelease(v.note, v.dur || "8n", time, v.vel ?? 0.35);
      }, sequence).start(0);

      Tone.Transport.loop = true; Tone.Transport.loopEnd = "16m";
      Tone.Transport.start("+0.1");
      stopBtn.disabled = false; playBtn.disabled = true;
    });

    stopBtn.addEventListener('click', () => {
      Tone.Transport.stop();
      playBtn.disabled = false;
      stopBtn.disabled = true;
    });
  </script>
</body>
</html>
