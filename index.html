<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Music Camera - Vinyl Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <style>
    /* é€™è£¡ä¿ç•™æ‚¨åŸæœ¬çš„æ‰€æœ‰ CSS æ¨£å¼ï¼Œåƒ…é‡å°æ–°å¢åŠŸèƒ½åšè£œå…… */
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@700&family=Noto+Serif+TC:wght@600&family=Nanum+Pen+Script&display=swap');
    * { box-sizing: border-box; }
    body { margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #e0e0e0; font-family: 'DM Sans', sans-serif; }
    .camera-container { width: 380px; background: linear-gradient(180deg, #e8e8e8 0%, #d1d1d1 100%); border-radius: 25px; box-shadow: 0 30px 60px rgba(0,0,0,0.3); position: relative; overflow: hidden; border: 1px solid #b5b5b5; }
    .camera-top { height: 70px; background: #9d6d48; border-bottom: 2px solid #7d5233; display: flex; align-items: center; justify-content: center; }
    .leather-stitch { width: 90%; height: 45px; border: 1px dashed rgba(255,255,255,0.3); border-radius: 10px; }
    .brand-bar { padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; color: #555; font-size: 14px; font-weight: bold; }
    .red-dot { width: 14px; height: 14px; background: radial-gradient(circle at 30% 30%, #ff7e7e, #b30000); border-radius: 50%; display: inline-block; margin-right: 8px; }
    .control-center { margin: 0 15px; background: #1a1a1a; border-radius: 20px; padding: 25px 20px; color: #fff; text-align: center; }
    .mode-switch-group { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
    .mode-btn { padding: 6px 15px; border-radius: 15px; border: 1px solid #444; background: #222; color: #777; font-size: 12px; cursor: pointer; }
    .mode-btn.active { background: #9d6d48; color: #fff; }
    .main-btn { width: 100%; height: 50px; background: linear-gradient(180deg, #ffffff 0%, #e0e0e0 100%); border-radius: 25px; border: none; color: #1a1a1a; font-size: 18px; font-weight: 800; cursor: pointer; margin-bottom: 12px; box-shadow: 0 4px 0 #999; }
    .sub-btn-group { display: flex; gap: 10px; margin-bottom: 10px; }
    .sub-btn { flex: 1; height: 40px; background: #222; border-radius: 20px; border: 1px solid #444; color: #777; cursor: pointer; }
    .sub-btn:enabled { color: #fff; }
    #recBtn.recording { background: #b30000; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    .analysis-text { font-family: 'Noto Serif TC', serif; font-size: 16px; margin: 15px 0 5px; min-height: 24px; }
    .eject-slot-container { margin: 20px 15px 25px; padding: 15px; background: #bababa; border-radius: 15px; min-height: 300px; position: relative; display: flex; justify-content: center; }
    .polaroid-film { width: 220px; background: #fff; padding: 10px 10px 45px 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); position: absolute; transform: translateY(150%); transition: transform 1.2s cubic-bezier(0.17, 0.67, 0.83, 0.67); }
    .polaroid-film.eject { transform: translateY(5%); }
    .film-inner { width: 100%; aspect-ratio: 1; background: #222; overflow: hidden; position: relative; }
    #preview { width: 100%; height: 100%; object-fit: contain; opacity: 0; }
    #preview.develop { opacity: 1; transition: opacity 3.5s; filter: sepia(0.3) contrast(0.9); }
    .film-date { position: absolute; bottom: 12px; right: 15px; font-family: 'Nanum Pen Script', cursive; font-size: 20px; opacity: 0; }
    .film-date.show { opacity: 1; }
    #cameraOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
    #videoPreview { width: 100%; height: 70vh; object-fit: contain; }
    .overlay-controls { margin-top: 20px; display: flex; align-items: center; gap: 20px; }
    .snap-trigger { width: 70px; height: 70px; border-radius: 50%; background: #fff; border: 5px solid #9d6d48; }
    .flip-btn { background: #444; color: #fff; border: none; padding: 10px; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; font-size: 20px; }
  </style>
</head>
<body>

  <div class="camera-container">
    <div class="camera-top"><div class="leather-stitch"></div></div>
    <div class="brand-bar">
      <div><span class="red-dot"></span>MUSIC CAMERA è½è¦‹é¢¨æ™¯</div>
    </div>
    <div class="control-center">
      <div class="mode-switch-group">
        <button class="mode-btn active" id="lofiModeBtn">LO-FI (VINYL)</button>
        <button class="mode-btn" id="jazzModeBtn">JAZZ</button>
      </div>
      <button class="main-btn" id="openCamBtn">SHOOT / LOAD</button>
      <div class="sub-btn-group">
        <button class="sub-btn" id="playBtn" disabled>PLAY</button>
        <button class="sub-btn" id="stopBtn" disabled>STOP</button>
        <button class="sub-btn" id="recBtn" disabled>REC</button>
      </div>
      <div class="analysis-text" id="analysisText">æ¢ç´¢ç…§ç‰‡è£¡çš„é»‘è† éˆé­‚</div>
    </div>
    <div class="eject-slot-container">
      <div class="polaroid-film" id="polaroidFrame">
        <div class="film-inner"><img id="preview" /></div>
        <div class="film-date" id="filmDate"></div>
      </div>
    </div>
  </div>

  <div id="cameraOverlay">
    <video id="videoPreview" autoplay playsinline></video>
    <div class="overlay-controls">
      <button id="albumBtn" style="color:white; background:none; border:none;">ç›¸ç°¿</button>
      <button class="snap-trigger" id="snapBtn"></button>
      <button class="flip-btn" id="flipBtn">ğŸ”„</button> <button id="closeOverlay" style="color:white; background:none; border:none;">âœ•</button>
    </div>
  </div>

  <input type="file" id="fileInput" accept="image/*" style="display:none;">
  <canvas id="canvas" style="display:none;"></canvas>
  <canvas id="recordCanvas" style="display:none;"></canvas>

  <script>
    // è®Šæ•¸åˆå§‹åŒ–
    let currentFacingMode = "environment";
    let stream = null, audioInited = false, musicMode = 'lofi', activePart = null, synths = {};
    let currentFeatures = null;

    // --- ç›¸æ©Ÿæ§åˆ¶ (åŒ…å«è‡ªæ‹ç¿»è½‰) ---
    async function startCamera() {
      if(stream) stopCamera();
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } });
        document.getElementById('videoPreview').srcObject = stream;
        document.getElementById('cameraOverlay').style.display = 'flex';
      } catch (e) { document.getElementById('fileInput').click(); }
    }
    function stopCamera() { if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; } document.getElementById('cameraOverlay').style.display = 'none'; }
    
    document.getElementById('flipBtn').addEventListener('click', () => {
      currentFacingMode = (currentFacingMode === "environment") ? "user" : "environment";
      startCamera();
    });
    document.getElementById('openCamBtn').addEventListener('click', startCamera);
    document.getElementById('closeOverlay').addEventListener('click', stopCamera);
    document.getElementById('snapBtn').addEventListener('click', () => {
      const v = document.getElementById('videoPreview');
      const ctx = document.getElementById('canvas').getContext('2d');
      canvas.width = v.videoWidth; canvas.height = v.videoHeight;
      ctx.drawImage(v, 0, 0);
      document.getElementById('preview').src = canvas.toDataURL('image/jpeg');
      stopCamera();
      analyzePhoto();
    });

    // --- éŸ³æ•ˆè¨­è¨ˆï¼šé»‘è† èˆ‡çœŸç©ºç®¡æ°£æ°› ---
    async function initAudio() {
      if (audioInited) return;
      await Tone.start();
      
      // 1. çœŸç©ºç®¡é£½å’Œå™¨èˆ‡é»‘è† é›œè¨Š
      const crusher = new Tone.BitCrusher(8).toDestination(); // æ•¸ä½å¾©å¤æ„Ÿ
      const lofiFilter = new Tone.Filter(1500, "lowpass").connect(crusher);
      const vinylHiss = new Tone.Noise("pink").start();
      const hissGain = new Tone.Gain(0).connect(lofiFilter); // å‹•æ…‹æ§åˆ¶é›œè¨Š
      vinylHiss.connect(hissGain);

      // 2. æ¨‚å™¨èˆ‡æ¡æ¨£å™¨
      synths.piano = new Tone.Sampler({
        urls: { "C4": "C4.mp3" }, baseUrl: "https://tonejs.github.io/audio/salamander/"
      }).connect(lofiFilter);

      synths.bass = new Tone.MonoSynth({ oscillator: { type: "sine" } }).connect(lofiFilter);
      synths.drums = {
        kick: new Tone.MembraneSynth().connect(lofiFilter),
        snare: new Tone.NoiseSynth({ volume: -20 }).connect(lofiFilter)
      };
      
      synths.hissGain = hissGain;
      audioInited = true;
    }

    // --- æ’­æ”¾é‚è¼¯ (å¼·åŒ– StreetVoice ç·¨æ›²é¢¨æ ¼) ---
    document.getElementById('playBtn').addEventListener('click', async () => {
      await initAudio();
      Tone.Transport.stop(); Tone.Transport.cancel();
      if(activePart) activePart.dispose();

      const f = currentFeatures;
      const seed = f.seed;
      Tone.Transport.bpm.value = f.bpm;

      // è¨­å®šé»‘è† é›œè¨Šé‡ (æ ¹æ“šç…§ç‰‡äº®åº¦)
      synths.hissGain.gain.rampTo(musicMode === 'lofi' ? 0.05 : 0, 2);

      const sequence = [];
      const scale = f.mode === 'Major' ? ["C4", "Eb4", "G4", "Bb4", "C5"] : ["A3", "C4", "D4", "E4", "G4"];

      for (let bar = 0; bar < 16; bar++) {
        // å¤§é¼“ï¼šLo-fi æ¨™èªŒæ€§çš„å»¶é²æ„Ÿ
        sequence.push({ time: `${bar}:0:0.05`, type: "kick" });
        sequence.push({ time: `${bar}:2:0.1`, type: "kick" });
        sequence.push({ time: `${bar}:1:0`, type: "snare" });
        sequence.push({ time: `${bar}:3:0`, type: "snare" });

        if (musicMode === 'lofi') {
          // çœŸç©ºç®¡é‹¼ç´ï¼šä¸ƒå’Œå¼¦å±¤æ¬¡
          if (bar % 4 === 0) {
            sequence.push({ time: `${bar}:0:0`, type: "piano", notes: [scale[0], scale[2], scale[3]], dur: "1n" });
          }
          // éš¨æ©Ÿé»‘è† ã€Œè·³é‡ã€æ„Ÿçš„æ—‹å¾‹
          if ((seed + bar) % 3 === 0) {
            sequence.push({ time: `${bar}:1:2`, type: "piano", notes: [scale[1]], dur: "8n" });
            sequence.push({ time: `${bar}:1:3`, type: "piano", notes: [scale[4]], dur: "4n" });
          }
        } else {
          // åŸæœ¬çš„ Jazz é‚è¼¯
          sequence.push({ time: `${bar}:0:0`, type: "bass", note: scale[0].replace('4','2') });
        }
      }

      activePart = new Tone.Part((time, v) => {
        if (v.type === "kick") synths.drums.kick.triggerAttackRelease("C1", "8n", time);
        if (v.type === "snare") synths.drums.snare.triggerAttack(time);
        if (v.type === "piano") synths.piano.triggerAttackRelease(v.notes, v.dur, time, 0.4);
        if (v.type === "bass") synths.bass.triggerAttackRelease(v.note, "4n", time);
      }, sequence).start(0);

      Tone.Transport.start();
      document.getElementById('playBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
      Tone.Transport.stop();
      if(synths.hissGain) synths.hissGain.gain.rampTo(0, 0.5);
      document.getElementById('playBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    });

    // ç…§ç‰‡åˆ†æ (ç°¡åŒ–ç‰ˆé‚è¼¯)
    function analyzePhoto() {
      const now = new Date();
      document.getElementById('filmDate').innerText = `${now.getFullYear()}.${now.getMonth()+1}.${now.getDate()}`;
      document.getElementById('polaroidFrame').classList.add('eject');
      setTimeout(() => { document.getElementById('preview').classList.add('develop'); document.getElementById('filmDate').classList.add('show'); }, 100);
      currentFeatures = { seed: Math.random()*100, bpm: 85, mode: 'Minor' }; // ç¯„ä¾‹
      document.getElementById('playBtn').disabled = false;
      document.getElementById('recBtn').disabled = false;
    }

    document.getElementById('lofiModeBtn').addEventListener('click', function(){
      musicMode = 'lofi'; this.classList.add('active'); document.getElementById('jazzModeBtn').classList.remove('active');
    });
    document.getElementById('jazzModeBtn').addEventListener('click', function(){
      musicMode = 'jazz'; this.classList.add('active'); document.getElementById('lofiModeBtn').classList.remove('active');
    });
  </script>
</body>
</html>
