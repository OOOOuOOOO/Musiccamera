<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Music Camera - Memory Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@700&family=Noto+Serif+TC:wght@600&family=Nanum+Pen+Script&display=swap');
    
    * { box-sizing: border-box; }
    body {
      margin: 0; min-height: 100vh;
      display: flex; align-items: center; justify-content: center;
      background: #e0e0e0; font-family: 'DM Sans', sans-serif;
    }

    /* --- 擬物化機身外觀 --- */
    .camera-container {
      width: 380px; background: linear-gradient(180deg, #e8e8e8 0%, #d1d1d1 100%);
      border-radius: 25px; box-shadow: 0 30px 60px rgba(0,0,0,0.3), inset 0 1px 2px #fff;
      position: relative; overflow: hidden; border: 1px solid #b5b5b5;
    }

    .camera-top {
      height: 70px; background: #9d6d48;
      background-image: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
      background-size: 4px 4px; border-bottom: 2px solid #7d5233;
      display: flex; align-items: center; justify-content: center;
    }
    .leather-stitch {
      width: 90%; height: 45px; border: 1px dashed rgba(255,255,255,0.3);
      border-radius: 10px; box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
    }

    .brand-bar {
      padding: 12px 20px; display: flex; align-items: center; justify-content: space-between;
      color: #555; font-size: 14px; font-weight: bold;
    }
    .red-dot {
      width: 14px; height: 14px; background: radial-gradient(circle at 30% 30%, #ff7e7e, #b30000);
      border-radius: 50%; display: inline-block; margin-right: 8px;
    }

    .control-center {
      margin: 0 15px; background: #1a1a1a; border-radius: 20px; padding: 25px 20px;
      box-shadow: inset 0 4px 10px rgba(0,0,0,0.8), 0 1px 1px #fff; color: #fff; text-align: center;
    }

    .mode-switch-group {
      display: flex; justify-content: center; gap: 10px; margin-bottom: 15px;
    }
    .mode-btn {
      padding: 6px 15px; border-radius: 15px; border: 1px solid #444; 
      background: #222; color: #777; font-size: 12px; cursor: pointer; transition: 0.3s;
    }
    .mode-btn.active {
      background: #9d6d48; color: #fff; border-color: #7d5233;
    }

    .main-btn {
      width: 100%; height: 50px; background: linear-gradient(180deg, #ffffff 0%, #e0e0e0 100%);
      border-radius: 25px; border: none; color: #1a1a1a; font-size: 18px; font-weight: 800;
      cursor: pointer; margin-bottom: 12px; box-shadow: 0 4px 0 #999, 0 8px 15px rgba(0,0,0,0.4);
      display: flex; align-items: center; justify-content: center;
    }
    .main-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #999; }

    .sub-btn-group { display: flex; gap: 10px; margin-bottom: 10px; }
    .sub-btn {
      flex: 1; height: 40px; background: linear-gradient(180deg, #333 0%, #222 100%);
      border-radius: 20px; border: 1px solid #444; color: #777; font-weight: bold; cursor: pointer;
    }
    .sub-btn:enabled { color: #fff; }

    /* 錄影按鈕特殊樣式 */
    #recBtn.recording {
      background: #b30000;
      color: #fff;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }
    }

    .analysis-text {
      font-family: 'Noto Serif TC', serif; font-size: 16px; color: #fff;
      margin: 15px 0 5px; min-height: 24px; line-height: 1.6; letter-spacing: 2px;
    }

    .eject-slot-container {
      margin: 20px 15px 25px; padding: 15px; background: #bababa; border-radius: 15px;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); 
      min-height: 300px; position: relative; overflow: hidden; display: flex; justify-content: center;
    }
    .black-exit-line {
      position: absolute; bottom: 15px; width: 92%; height: 10px;
      background: #000; border-radius: 5px; box-shadow: 0 1px 1px #fff;
    }

    .polaroid-film {
      width: 220px; background: #fff; padding: 10px 10px 45px 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3); position: absolute;
      transform: translateY(150%); transition: transform 1.2s cubic-bezier(0.17, 0.67, 0.83, 0.67); z-index: 10;
    }
    .polaroid-film.eject { transform: translateY(5%); }
    .film-inner {
      width: 100%; aspect-ratio: 1; background: #222; overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      box-shadow: inset 0 0 40px rgba(0,0,0,0.6);
      position: relative;
    }
    #preview { width: 100%; height: 100%; object-fit: contain; opacity: 0; }
    
    #preview.develop { 
      opacity: 1; 
      transition: opacity 3.5s; 
      filter: sepia(0.25) contrast(0.9) brightness(1.1) saturate(1.2);
    }

    .film-inner::after {
      content: "";
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, 
        rgba(255, 80, 0, 0.45) 0%, 
        rgba(255, 150, 50, 0.2) 35%, 
        transparent 70%
      );
      pointer-events: none;
      mix-blend-mode: screen; 
      opacity: 0;
    }

    .polaroid-film.eject .film-inner::after {
      opacity: 1;
      transition: opacity 4s 1s; 
    }
    
    .film-date {
      position: absolute; bottom: 12px; right: 15px;
      font-family: 'Nanum Pen Script', cursive;
      font-size: 20px; color: #444; opacity: 0;
    }
    .film-date.show { opacity: 1; transition: opacity 2s 1.5s; }

    #cameraOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000;
    }
    #videoPreview { width: 100%; max-width: 100%; max-height: 70vh; object-fit: contain; }
    .overlay-controls { margin-top: 30px; display: flex; align-items: center; gap: 40px; }
    .snap-trigger { width: 70px; height: 70px; border-radius: 50%; background: #fff; border: 5px solid #9d6d48; cursor: pointer;}

    /* 隱藏錄製用的 Canvas */
    #recordCanvas { display: none; }
    #canvas { display: none; }
  </style>
</head>
<body>

  <div class="camera-container">
    <div class="camera-top"><div class="leather-stitch"></div></div>
    <div class="brand-bar">
      <div><span class="red-dot"></span>MUSIC CAMERA 聽見風景</div>
      <div style="width:35px; height:15px; background:linear-gradient(to right, #ddd, #fff, #ddd); border-radius:10px; border:1px solid #aaa;"></div>
    </div>

    <div class="control-center">
      <div class="mode-switch-group">
        <button class="mode-btn active" id="lofiModeBtn">LO-FI</button>
        <button class="mode-btn" id="jazzModeBtn">JAZZ</button>
      </div>

      <button class="main-btn" id="openCamBtn">SHOOT / LOAD</button>
      <div class="sub-btn-group">
        <button class="sub-btn" id="playBtn" disabled>PLAY</button>
        <button class="sub-btn" id="stopBtn" disabled>STOP</button>
        <button class="sub-btn" id="recBtn" disabled>REC / SAVE</button>
      </div>
      <div class="analysis-text" id="analysisText">每個回憶，都是一段獨一無二的旋律</div>
    </div>

    <div class="eject-slot-container">
      <div class="polaroid-film" id="polaroidFrame">
        <div class="film-inner"><img id="preview" alt="Snapshot"/></div>
        <div class="film-date" id="filmDate"></div>
      </div>
      <div class="black-exit-line"></div>
    </div>
  </div>

  <div id="cameraOverlay">
    <video id="videoPreview" autoplay playsinline></video>
   <div class="overlay-controls">
  <button id="albumBtn" style="background:#444; color:#fff; border:none; padding:10px 20px; border-radius:20px; cursor:pointer;">相簿</button>
  <button class="snap-trigger" id="snapBtn"></button>
  <button id="switchCamBtn" style="background:rgba(255,255,255,0.2); color:#fff; border:1px solid #fff; width:40px; height:40px; border-radius:50%; cursor:pointer;">⇄</button>
  <button id="closeOverlay" style="color:white; background:none; border:none; cursor:pointer;">✕</button>
</div>
  </div>
  
  <input type="file" id="fileInput" accept="image/*" style="display:none;">
  <canvas id="canvas"></canvas>
  <canvas id="recordCanvas"></canvas>
  <audio id="shutterSfx" src="polaroid-shutter.mp3"></audio>

  <script>
    const openCamBtn = document.getElementById('openCamBtn');
    const cameraOverlay = document.getElementById('cameraOverlay');
    const videoPreview = document.getElementById('videoPreview');
    const snapBtn = document.getElementById('snapBtn');
    const albumBtn = document.getElementById('albumBtn');
    const fileInput = document.getElementById('fileInput');
    const closeOverlay = document.getElementById('closeOverlay');
    const preview = document.getElementById('preview');
    const polaroidFrame = document.getElementById('polaroidFrame');
    const analysisText = document.getElementById('analysisText');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const recBtn = document.getElementById('recBtn');
    const filmDate = document.getElementById('filmDate');
    const shutterSfx = document.getElementById('shutterSfx');
    const canvas = document.getElementById('canvas');
    const recordCanvas = document.getElementById('recordCanvas');
    const lofiModeBtn = document.getElementById('lofiModeBtn');
    const jazzModeBtn = document.getElementById('jazzModeBtn');
    const switchCamBtn = document.getElementById('switchCamBtn');
let currentFacingMode = "environment";

    let stream = null, audioInited = false, currentFeatures = null, synths = {}, musicMode = 'lofi';
    let mediaRecorder, recordedChunks = [];

    const tagMatrix = {
      'Energetic': { text: "充滿活力的節奏", bpmAdd: 15, density: 0.9, reverb: 0.2 },
      'Dreamy': { text: "如夢似幻的泡影", bpmAdd: -5, density: 0.4, reverb: 0.8 },
      'Bright': { text: "捕捉光芒的瞬間", bpmAdd: 5, density: 0.7, reverb: 0.3 },
      'Calm': { text: "呼吸間的寧靜", bpmAdd: -10, density: 0.3, reverb: 0.5 },
      'Cozy': { text: "暖色調的午後", bpmAdd: -2, density: 0.5, reverb: 0.4 },
      'Nostalgic': { text: "泛黃的舊時光", bpmAdd: -8, density: 0.4, reverb: 0.6 },
      'Urban': { text: "都市霓虹的閃爍", bpmAdd: 10, density: 0.8, reverb: 0.3 },
      'Tense': { text: "緊繃的視覺張力", bpmAdd: 12, density: 0.9, reverb: 0.4 },
      'Mysterious': { text: "深邃神祕的暗影", bpmAdd: -4, density: 0.5, reverb: 0.7 },
      'Melancholy': { text: "雨後的憂鬱藍調", bpmAdd: -12, density: 0.3, reverb: 0.7 },
      'Lonely': { text: "看見一抹寂靜", bpmAdd: -15, density: 0.2, reverb: 0.9 },
      'Static': { text: "凝結永恆的靜物", bpmAdd: -20, density: 0.1, reverb: 0.8 }
    };

    lofiModeBtn.addEventListener('click', () => { musicMode = 'lofi'; lofiModeBtn.classList.add('active'); jazzModeBtn.classList.remove('active'); });
    jazzModeBtn.addEventListener('click', () => { musicMode = 'jazz'; jazzModeBtn.classList.add('active'); lofiModeBtn.classList.remove('active'); });

    async function startCamera() {
  if (stream) { stream.getTracks().forEach(t => t.stop()); } // 切換前先停止舊串流
  try {
    stream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: currentFacingMode } 
    });
    videoPreview.srcObject = stream;
    cameraOverlay.style.display = 'flex';
  } catch (e) { fileInput.click(); }
}
    function stopCamera() { if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; } cameraOverlay.style.display = 'none'; }
    openCamBtn.addEventListener('click', startCamera);
    closeOverlay.addEventListener('click', stopCamera);
    albumBtn.addEventListener('click', () => fileInput.click());
    switchCamBtn.addEventListener('click', () => {
  currentFacingMode = (currentFacingMode === "environment") ? "user" : "environment";
  startCamera(); 
});

    snapBtn.addEventListener('click', () => {
      const ctx = canvas.getContext('2d');
      canvas.width = videoPreview.videoWidth; canvas.height = videoPreview.videoHeight;
      ctx.drawImage(videoPreview, 0, 0);
      preview.src = canvas.toDataURL('image/jpeg');
      stopCamera();
      analyzePhoto();
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => { preview.src = ev.target.result; stopCamera(); analyzePhoto(); };
      reader.readAsDataURL(file);
    });

    function analyzePhoto() {
      preview.onload = () => {
        const ctx = canvas.getContext('2d');
        canvas.width = 10; canvas.height = 10;
        ctx.drawImage(preview, 0, 0, 10, 10);
        const data = ctx.getImageData(0, 0, 10, 10).data;
        let r=0, g=0, b=0, bri=0;
        for(let i=0; i<data.length; i+=4){ r+=data[i]; g+=data[i+1]; b+=data[i+2]; bri+=(data[i]+data[i+1]+data[i+2])/3; }
        
        const tags = Object.keys(tagMatrix);
        let tagIndex = (r + g + b) % tags.length;
        if (bri > 200) tagIndex = 2; 
        if (bri < 50) tagIndex = 8;  
        if (b > r + 50) tagIndex = 9; 
        
        const selectedTag = tags[tagIndex];
        currentFeatures = { 
          tag: selectedTag,
          tagInfo: tagMatrix[selectedTag],
          mode: (bri/100) > 125 ? 'Major' : 'Minor',
          seed: (r + g + b),
          bpm: 90 + tagMatrix[selectedTag].bpmAdd
        };

        analysisText.innerHTML = `讓音樂完整回憶`;
        triggerEject();
      };
    }
    
    function triggerEject() {
      const now = new Date();
      filmDate.innerText = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}`;
      filmDate.classList.remove('show');
      polaroidFrame.classList.remove('eject');
      void polaroidFrame.offsetWidth;
      polaroidFrame.classList.add('eject');
      preview.classList.remove('develop');
      shutterSfx.currentTime = 0; shutterSfx.play().catch(()=>{});
      setTimeout(() => { preview.classList.add('develop'); filmDate.classList.add('show'); }, 100);
      playBtn.disabled = false;
      recBtn.disabled = false;
    }

    async function initAudio() {
      if (audioInited) return;
      await Tone.start();
      const filter = new Tone.Filter(1200, "lowpass").toDestination();
      synths.reverb = new Tone.Reverb({ decay: 4, wet: 0.3 }).connect(filter);
      const chorus = new Tone.Chorus(4, 2.5, 0.5).connect(synths.reverb).start(); 

      synths.noise = new Tone.Noise("pink").connect(new Tone.Filter(800, "lowpass").toDestination());
      synths.noise.volume.value = -Infinity; 
      synths.noise.start();

      synths.piano = new Tone.Sampler({
        urls: { A1: "A1.mp3", C4: "C4.mp3" },
        baseUrl: "https://tonejs.github.io/audio/salamander/",
      }).connect(synths.reverb);

      synths.guitar = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "triangle" },
        envelope: { attack: 0.02, decay: 0.8, sustain: 0.1, release: 1.2 }
      }).connect(chorus);

      synths.bass = new Tone.MonoSynth({ oscillator: { type: "sine" } }).toDestination();
      synths.kick = new Tone.MembraneSynth({ volume: -25 }).connect(filter);
      synths.snare = new Tone.NoiseSynth({ volume: -38 }).connect(filter);
      audioInited = true;
    }

   // --- 【核心音樂引擎：Lo-Fi 優化 + Jazz 保留】 ---
    const chordProgressions = {
      warm: [["Cmaj7", "Am7", "Dm7", "G7"], ["Fmaj7", "G7", "Em7", "Am7"], ["Cmaj7", "Fmaj7", "Dm7", "E7"]],
      deep: [["Am7", "Dm7", "G7", "Cmaj7"], ["Fmaj7", "E7", "Am7", "Gm7"], ["Dm7", "G7", "Cmaj7", "A7"]]
    };

    let activePart = null;

    // 播放按鈕
    playBtn.addEventListener('click', async () => {
      await initAudio();
      
      // 1. 徹底停止並清理舊的播放內容
      Tone.Transport.stop();
      Tone.Transport.cancel();
      if(activePart) { activePart.dispose(); activePart = null; }
      
      const f = currentFeatures;
      const seed = f.seed;
      const info = f.tagInfo;

      // 2. 空間濾鏡設置 (Lo-Fi 專屬)
      let distance = "near";
      if (f.tag === 'Lonely' || f.tag === 'Melancholy' || f.tag === 'Mysterious') distance = "far";
      else if (f.tag === 'Nostalgic' || f.tag === 'Dreamy' || f.tag === 'Calm') distance = "muffled";

      if (musicMode === 'lofi') {
        const wet = (distance === "far") ? 0.7 : (distance === "muffled" ? 0.5 : 0.25);
        synths.reverb.wet.rampTo(wet, 1);
        synths.noise.volume.rampTo(distance === "near" ? -45 : -35, 2);
      } else {
        synths.noise.volume.rampTo(-Infinity, 1);
        synths.reverb.wet.value = 0.3;
      }

      Tone.Transport.bpm.value = f.bpm;
      const sequence = [];

      // 3. 模式判斷
      if (musicMode === 'lofi') {
        // --- Lo-Fi StreetVoice 旋律生成 ---
        const category = f.mode === 'Major' ? 'warm' : 'deep';
        const prog = chordProgressions[category][seed % 3];
        const scale = f.mode === 'Major' ? ["C4", "D4", "E4", "G4", "A4", "C5"] : ["A3", "C4", "D4", "E4", "G4", "A4"];
        
        for (let bar = 0; bar < 16; bar++) {
          const root = prog[bar % prog.length][0].substring(0, 1) + "3";
          
          // 節奏層 (呼吸感)
          sequence.push({ time: `${bar}:0:0`, type: "kick" });
          sequence.push({ time: `${bar}:1:0.2`, type: "snare" });
          sequence.push({ time: `${bar}:2:0`, type: "kick" });
          sequence.push({ time: `${bar}:3:0.2`, type: "snare" });
          sequence.push({ time: `${bar}:0:1`, type: "bass", note: root.replace('3','2') });

          // 豐富旋律層：雙聲部鋼琴 (確保旋律連貫)
          if (bar % 2 === 0) {
            sequence.push({ time: `${bar}:0:2`, type: "piano", note: scale[seed % 4], dur: "2n" });
            sequence.push({ time: `${bar}:1:2`, type: "piano", note: scale[(seed + 1) % 5], dur: "4n" });
          } else {
            sequence.push({ time: `${bar}:0:0`, type: "piano", note: scale[(seed + bar) % 6], dur: "4n" });
            sequence.push({ time: `${bar}:1:0`, type: "piano", note: scale[(seed + 2) % 6], dur: "4n" });
            if (seed % 3 === 0) {
              sequence.push({ time: `${bar}:2:2`, type: "piano", note: scale[seed % 6].replace('4','5'), dur: "2n" });
            }
          }
        }
      } else {
        // --- Jazz 邏輯（完整保留舊有內容） ---
        const jazzScale = ["C3", "Eb3", "F3", "Gb3", "G3", "Bb3", "C4"];
        Tone.Transport.swing = 0.4;
        for (let bar = 0; bar < 16; bar++) {
          sequence.push({ time: `${bar}:0:0`, type: "kick" });
          sequence.push({ time: `${bar}:1:0`, type: "snare" });
          sequence.push({ time: `${bar}:2:0`, type: "kick" });
          sequence.push({ time: `${bar}:3:0`, type: "snare" });
          for (let beat = 0; beat < 4; beat++) {
            if (Math.random() < 0.6) {
              sequence.push({ time: `${bar}:${beat}:0`, type: "bass", note: jazzScale[(seed + beat) % 7].replace('3','2') });
            }
          }
          if (bar % 4 === 0) {
            sequence.push({ time: `${bar}:0:2`, type: "piano", notes: ["C3", "Eb3", "G3"], dur: "2n" });
          }
        }
      }

      activePart = new Tone.Part((time, v) => {
        if (v.type === "kick") synths.kick.triggerAttackRelease("C1", "8n", time);
        if (v.type === "snare") synths.snare.triggerAttack(time);
        if (v.type === "bass") synths.bass.triggerAttackRelease(v.note, "2n", time, 0.4);
        if (v.type === "piano" && synths.piano.loaded) {
          const vel = musicMode === 'lofi' ? (0.3 + Math.random() * 0.2) : 0.5;
          synths.piano.triggerAttackRelease(v.notes || v.note, v.dur || "4n", time, vel);
        }
      }, sequence).start(0);

      Tone.Transport.loop = true; 
      Tone.Transport.loopEnd = "16m";
      Tone.Transport.start("+0.1");
      
      stopBtn.disabled = false; playBtn.disabled = true;
    });

    // 停止按鈕 (徹底修正：確保聲音切斷)
    stopBtn.addEventListener('click', () => { 
      Tone.Transport.stop(); 
      Tone.Transport.cancel(); 
      if(activePart) { activePart.dispose(); activePart = null; }
      
      // 靜音所有合成器防止殘音
      Object.values(synths).forEach(s => {
        if(s.volume) s.volume.rampTo(-Infinity, 0.2);
        if(s.releaseAll) s.releaseAll();
      });
      
      playBtn.disabled = false; 
      stopBtn.disabled = true; 
    });
    // --- 音樂生成邏輯結束 ---

    // --- 新增：影片錄製功能 ---

    recBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        recBtn.classList.remove('recording');
        recBtn.innerText = "REC / SAVE";
      } else {
        startRecording();
      }
    });

   async function startRecording() {
      await initAudio();
      recordedChunks = [];
      
      // 1. 自動偵測支援的格式
      const types = ["video/mp4", "video/webm;codecs=vp9,opus", "video/webm;codecs=vp8,opus", "video/webm"];
      let supportedType = types.find(type => MediaRecorder.isTypeSupported(type));

      if (!supportedType) {
        alert("您的瀏覽器不支援錄影功能。");
        return;
      }

      recordCanvas.width = 400; 
      recordCanvas.height = 500;
      const rCtx = recordCanvas.getContext('2d');

      function updateCanvas() {
        if (!mediaRecorder || mediaRecorder.state !== "recording") return;
        
        // 繪製拍立得白底背景
        rCtx.fillStyle = "#fff";
        rCtx.fillRect(0, 0, 400, 500);
        
        // --- 修正變形：中心裁剪繪製 ---
        const img = preview;
        const targetSize = 360; // 影片中照片顯示的大小
        const targetX = 20;     // 邊距
        const targetY = 20;

        if (img.complete && img.naturalWidth > 0) {
          const sw = img.naturalWidth;
          const sh = img.naturalHeight;
          const minSide = Math.min(sw, sh);
          const sx = (sw - minSide) / 2;
          const sy = (sh - minSide) / 2;

          // drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight)
          rCtx.drawImage(img, sx, sy, minSide, minSide, targetX, targetY, targetSize, targetSize);
        } else {
          // 若圖片未加載完成，填入深色背景
          rCtx.fillStyle = "#222";
          rCtx.fillRect(targetX, targetY, targetSize, targetSize);
        }
        
        // 繪製日期
        rCtx.font = "24px 'Nanum Pen Script'";
        rCtx.fillStyle = "#444";
        rCtx.fillText(filmDate.innerText, 280, 460);
        
        requestAnimationFrame(updateCanvas);
      }

      // 2. 獲取流
      const canvasStream = recordCanvas.captureStream(30);
      const audioDest = Tone.getContext().rawContext.createMediaStreamDestination();
      Tone.getDestination().connect(audioDest);
      
      const combinedStream = new MediaStream([
        ...canvasStream.getVideoTracks(),
        ...audioDest.stream.getAudioTracks()
      ]);

      // 3. 啟動
      mediaRecorder = new MediaRecorder(combinedStream, { 
        mimeType: supportedType,
        videoBitsPerSecond : 2500000 
      });
      
      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: supportedType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Memory_${Date.now()}.${supportedType.includes('mp4') ? 'mp4' : 'webm'}`;
        a.click();
      };

      mediaRecorder.start();
      recBtn.classList.add('recording');
      recBtn.innerText = "STOP & SAVE";
      updateCanvas();
      
      if (Tone.Transport.state !== "started") playBtn.click();
    }
    
  </script>
</body>
</html>
