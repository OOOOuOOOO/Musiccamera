<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Music Camera - Memory Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@700&family=Noto+Serif+TC:wght@600&family=Nanum+Pen+Script&display=swap');
    
    * { box-sizing: border-box; }
    body {
      margin: 0; min-height: 100vh;
      display: flex; align-items: center; justify-content: center;
      background: #e0e0e0; font-family: 'DM Sans', sans-serif;
    }

    /* --- 擬物化機身外觀 --- */
    .camera-container {
      width: 380px; background: linear-gradient(180deg, #e8e8e8 0%, #d1d1d1 100%);
      border-radius: 25px; box-shadow: 0 30px 60px rgba(0,0,0,0.3), inset 0 1px 2px #fff;
      position: relative; overflow: hidden; border: 1px solid #b5b5b5;
    }

    .camera-top {
      height: 70px; background: #9d6d48;
      background-image: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
      background-size: 4px 4px; border-bottom: 2px solid #7d5233;
      display: flex; align-items: center; justify-content: center;
    }
    .leather-stitch {
      width: 90%; height: 45px; border: 1px dashed rgba(255,255,255,0.3);
      border-radius: 10px; box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
    }

    .brand-bar {
      padding: 12px 20px; display: flex; align-items: center; justify-content: space-between;
      color: #555; font-size: 14px; font-weight: bold;
    }
    .red-dot {
      width: 14px; height: 14px; background: radial-gradient(circle at 30% 30%, #ff7e7e, #b30000);
      border-radius: 50%; display: inline-block; margin-right: 8px;
    }

    .control-center {
      margin: 0 15px; background: #1a1a1a; border-radius: 20px; padding: 25px 20px;
      box-shadow: inset 0 4px 10px rgba(0,0,0,0.8), 0 1px 1px #fff; color: #fff; text-align: center;
    }

    /* 新增：風格切換開關樣式 */
    .style-selector {
      display: flex; justify-content: center; align-items: center;
      margin-bottom: 15px; gap: 10px; font-size: 12px; color: #888;
    }
    .toggle-switch {
      position: relative; display: inline-block; width: 44px; height: 22px;
    }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #333; transition: .4s; border-radius: 34px; border: 1px solid #444;
    }
    .slider:before {
      position: absolute; content: ""; height: 14px; width: 14px; left: 4px; bottom: 3px;
      background-color: #888; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: #9d6d48; }
    input:checked + .slider:before { transform: translateX(22px); background-color: white; }
    .active-label { color: #fff; font-weight: bold; }

    .main-btn {
      width: 100%; height: 50px; background: linear-gradient(180deg, #ffffff 0%, #e0e0e0 100%);
      border-radius: 25px; border: none; color: #1a1a1a; font-size: 18px; font-weight: 800;
      cursor: pointer; margin-bottom: 12px; box-shadow: 0 4px 0 #999, 0 8px 15px rgba(0,0,0,0.4);
      display: flex; align-items: center; justify-content: center;
    }
    .main-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #999; }

    .sub-btn-group { display: flex; gap: 10px; margin-bottom: 10px; }
    .sub-btn {
      flex: 1; height: 40px; background: linear-gradient(180deg, #333 0%, #222 100%);
      border-radius: 20px; border: 1px solid #444; color: #777; font-weight: bold; cursor: pointer;
    }
    .sub-btn:enabled { color: #fff; }

    .analysis-text {
      font-family: 'Noto Serif TC', serif; font-size: 16px; color: #fff;
      margin: 15px 0 5px; min-height: 24px; line-height: 1.6; letter-spacing: 2px;
    }

    .eject-slot-container {
      margin: 20px 15px 25px; padding: 15px; background: #bababa; border-radius: 15px;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); 
      min-height: 300px; position: relative; overflow: hidden; display: flex; justify-content: center;
    }
    .black-exit-line {
      position: absolute; bottom: 15px; width: 92%; height: 10px;
      background: #000; border-radius: 5px; box-shadow: 0 1px 1px #fff;
    }

    .polaroid-film {
      width: 220px; background: #fff; padding: 10px 10px 45px 10px; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.3); position: absolute;
      transform: translateY(150%); transition: transform 1.2s cubic-bezier(0.17, 0.67, 0.83, 0.67); z-index: 10;
    }
    .polaroid-film.eject { transform: translateY(5%); }
    .film-inner {
      width: 100%; aspect-ratio: 1; background: #222; overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      box-shadow: inset 0 0 40px rgba(0,0,0,0.6);
      position: relative;
    }
    #preview { width: 100%; height: 100%; object-fit: contain; opacity: 0; }
    
    #preview.develop { 
      opacity: 1; 
      transition: opacity 3.5s; 
      filter: sepia(0.25) contrast(0.9) brightness(1.1) saturate(1.2);
    }

    .film-inner::after {
      content: "";
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, 
        rgba(255, 80, 0, 0.45) 0%, 
        rgba(255, 150, 50, 0.2) 35%, 
        transparent 70%
      );
      pointer-events: none;
      mix-blend-mode: screen; 
      opacity: 0;
    }

    .polaroid-film.eject .film-inner::after {
      opacity: 1;
      transition: opacity 4s 1s; 
    }
    
    .film-date {
      position: absolute; bottom: 12px; right: 15px;
      font-family: 'Nanum Pen Script', cursive;
      font-size: 20px; color: #444; opacity: 0;
    }
    .film-date.show { opacity: 1; transition: opacity 2s 1.5s; }

    #cameraOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000;
    }
    #videoPreview { width: 100%; max-width: 100%; max-height: 70vh; object-fit: contain; }
    .overlay-controls { margin-top: 30px; display: flex; align-items: center; gap: 40px; }
    .snap-trigger { width: 70px; height: 70px; border-radius: 50%; background: #fff; border: 5px solid #9d6d48; }

    #canvas { display: none; }
  </style>
</head>
<body>

  <div class="camera-container">
    <div class="camera-top"><div class="leather-stitch"></div></div>
    <div class="brand-bar">
      <div><span class="red-dot"></span>MUSIC CAMERA 聽見風景</div>
      <div style="width:35px; height:15px; background:linear-gradient(to right, #ddd, #fff, #ddd); border-radius:10px; border:1px solid #aaa;"></div>
    </div>

    <div class="control-center">
      <div class="style-selector">
        <span id="lofiLabel" class="active-label">Lo-fi</span>
        <label class="toggle-switch">
          <input type="checkbox" id="styleToggle">
          <span class="slider"></span>
        </label>
        <span id="jazzLabel">Jazz</span>
      </div>

      <button class="main-btn" id="openCamBtn">SHOOT / LOAD</button>
      <div class="sub-btn-group">
        <button class="sub-btn" id="playBtn" disabled>PLAY</button>
        <button class="sub-btn" id="stopBtn" disabled>STOP</button>
      </div>
      <div class="analysis-text" id="analysisText">每個回憶，都是一段獨一無二的旋律</div>
    </div>

    <div class="eject-slot-container">
      <div class="polaroid-film" id="polaroidFrame">
        <div class="film-inner"><img id="preview" alt="Snapshot"/></div>
        <div class="film-date" id="filmDate"></div>
      </div>
      <div class="black-exit-line"></div>
    </div>
  </div>

  <div id="cameraOverlay">
    <video id="videoPreview" autoplay playsinline></video>
    <div class="overlay-controls">
      <button id="albumBtn" style="background:#444; color:#fff; border:none; padding:10px 20px; border-radius:20px;">相簿</button>
      <button class="snap-trigger" id="snapBtn"></button>
      <button id="closeOverlay" style="color:white; background:none; border:none; cursor:pointer;">✕</button>
    </div>
  </div>
  
  <input type="file" id="fileInput" accept="image/*" style="display:none;">
  <canvas id="canvas"></canvas>
  <audio id="shutterSfx" src="polaroid-shutter.mp3"></audio>

  <script>
    const openCamBtn = document.getElementById('openCamBtn');
    const cameraOverlay = document.getElementById('cameraOverlay');
    const videoPreview = document.getElementById('videoPreview');
    const snapBtn = document.getElementById('snapBtn');
    const albumBtn = document.getElementById('albumBtn');
    const fileInput = document.getElementById('fileInput');
    const closeOverlay = document.getElementById('closeOverlay');
    const preview = document.getElementById('preview');
    const polaroidFrame = document.getElementById('polaroidFrame');
    const analysisText = document.getElementById('analysisText');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const filmDate = document.getElementById('filmDate');
    const shutterSfx = document.getElementById('shutterSfx');
    const canvas = document.getElementById('canvas');
    const styleToggle = document.getElementById('styleToggle');
    const lofiLabel = document.getElementById('lofiLabel');
    const jazzLabel = document.getElementById('jazzLabel');

    let stream = null;
    let audioInited = false;
    let currentFeatures = null;
    let synths = {};

    // 切換 UI 標籤顏色
    styleToggle.addEventListener('change', () => {
      if(styleToggle.checked) {
        jazzLabel.classList.add('active-label');
        lofiLabel.classList.remove('active-label');
      } else {
        lofiLabel.classList.add('active-label');
        jazzLabel.classList.remove('active-label');
      }
    });

    // --- 僅需置換 script 內的 initAudio 與 playBtn 邏輯 ---

async function initAudio() {
  if (audioInited) return;
  await Tone.start();

  const filter = new Tone.Filter(1000, "lowpass").toDestination();
  const reverb = new Tone.Reverb({ decay: 5, wet: 0.4 }).connect(filter);

  // 1. 鋼琴 (通用)
  synths.piano = new Tone.Sampler({
    urls: { A1: "A1.mp3", C4: "C4.mp3" },
    baseUrl: "https://tonejs.github.io/audio/salamander/",
  }).connect(reverb);

  // 2. Lo-fi 專用：清脆吉他
  synths.guitar = new Tone.PolySynth(Tone.Synth, {
    oscillator: { type: "triangle" },
    envelope: { attack: 0.03, decay: 1.2, sustain: 0.1, release: 1.5 }
  }).connect(reverb);

  // 3. Jazz 專用：次中音薩克斯風 (Saxophone) 
  // 使用具備豐富諧波的鋸齒波，加上顫音 (Vibrato) 模擬吹奏感
  synths.sax = new Tone.MonoSynth({
    oscillator: { type: "sawtooth8" }, // 豐富的層次感
    filter: { Q: 2, type: "lowpass", rolloff: -24 },
    envelope: { attack: 0.1, decay: 0.3, sustain: 0.8, release: 1.2 },
    filterEnvelope: { attack: 0.2, baseFrequency: 300, octaves: 2, exponent: 2 }
  }).connect(reverb);
  
  // 增加薩克斯風的顫音效果
  const saxLFO = new Tone.LFO("5hz", -10, 10).connect(synths.sax.oscillator.detune).start();

  synths.kick = new Tone.MembraneSynth({ volume: -18 }).connect(filter);
  synths.snare = new Tone.NoiseSynth({ volume: -35 }).connect(filter);
  
  audioInited = true;
}

playBtn.addEventListener('click', async () => {
  await initAudio();
  Tone.Transport.stop();
  Tone.Transport.cancel();
  
  const f = currentFeatures;
  const isJazz = styleToggle.checked;
  
  // 差距化設定
  Tone.Transport.bpm.value = isJazz ? 72 : f.bpm; // Jazz 顯著變慢，變慵懶

  const sequence = [];
  for (let bar = 0; bar < 8; bar++) {
    // 鼓組
    sequence.push({ time: `${bar}:0:0`, type: "kick" });
    sequence.push({ time: `${bar}:2:0`, type: "kick" });
    sequence.push({ time: `${bar}:1:0`, type: "snare" });
    sequence.push({ time: `${bar}:3:0`, type: "snare" });

    if (isJazz) {
      // --- Jazz 模式邏輯 ---
      // 鋼琴彈奏「高級九和弦」
      if (bar % 2 === 0) {
        sequence.push({ 
          time: `${bar}:0:0`, 
          type: "piano", 
          notes: ["C3", "E3", "G3", "B3", "D4"] // 豐富的和聲
        });
      }
      // 薩克斯風吹奏「慵懶長音」與「即興裝飾」
      const saxScale = ["G4", "A4", "Bb4", "B4", "D5", "E5"]; // 帶有藍調味的音階
      sequence.push({ 
        time: `${bar}:0:2`, 
        type: "sax", 
        note: saxScale[Math.floor(Math.random()*saxScale.length)],
        dur: "1n" // 長音
      });
      if(Math.random() > 0.6) {
        sequence.push({ time: `${bar}:2:3`, type: "sax", note: saxScale[0], dur: "8n" });
      }
    } else {
      // --- Lo-fi 模式邏輯 ---
      const lofiScale = ["C4", "D4", "E4", "G4", "A4"];
      if (bar % 2 === 0) {
        sequence.push({ time: `${bar}:0:0`, type: "piano", notes: ["C4", "G4"] });
      }
      sequence.push({ time: `${bar}:0:2`, type: "guitar", note: lofiScale[Math.floor(Math.random()*lofiScale.length)] });
      sequence.push({ time: `${bar}:1:2`, type: "guitar", note: lofiScale[Math.floor(Math.random()*lofiScale.length)] });
      sequence.push({ time: `${bar}:2:1`, type: "guitar", note: lofiScale[Math.floor(Math.random()*lofiScale.length)] });
    }
  }

  new Tone.Part((time, v) => {
    if (v.type === "kick") synths.kick.triggerAttackRelease("C1", "8n", time);
    if (v.type === "snare") synths.snare.triggerAttack(time);
    if (v.type === "piano" && synths.piano.loaded) synths.piano.triggerAttackRelease(v.notes, "1n", time, 0.2);
    
    // 樂器分流
    if (v.type === "sax") synths.sax.triggerAttackRelease(v.note, v.dur, time, 0.4);
    if (v.type === "guitar") synths.guitar.triggerAttackRelease(v.note, "2n", time, 0.4);
  }, sequence).start(0);

  Tone.Transport.loop = true;
  Tone.Transport.loopEnd = "8m";
  Tone.Transport.start("+0.1");
  stopBtn.disabled = false;
  playBtn.disabled = true;
});
    
    stopBtn.addEventListener('click', () => {
      Tone.Transport.stop();
      playBtn.disabled = false;
      stopBtn.disabled = true;
    });
  </script>
</body>
</html>
