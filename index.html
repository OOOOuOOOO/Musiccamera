<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Music Camera - Original UI with Vibe Lo-Fi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Libre+Barcode+39+Text&family=Noto+Serif+TC:wght@500&display=swap');
    * { box-sizing: border-box; }

    /* =========================
       新外觀：參考你提供的截圖
       只改 UI / CSS，不動 JS
    ========================== */

    :root{
      --bg: #e9e9e9;

      --metal1:#eef0f2;
      --metal2:#d6dade;
      --metal3:#b8bfc6;

      --metalEdge:#9aa3ab;

      --leather1:#b17f55;
      --leather2:#8e6441;
      --stitch:#d4b184;

      --panelOuter:#0d0f12;
      --panelInner:#0a0b0d;
      --panelGlow: rgba(255,255,255,.06);

      --ink:#e9ecef;
      --muted: rgba(233,236,239,.65);

      --shadow: rgba(0,0,0,.35);
    }

    body {
      margin: 0; min-height: 100vh;
      display: flex; align-items: center; justify-content: center;
      padding: 18px;
      background: radial-gradient(circle at 50% 10%, #ffffff 0, #f1f1f1 35%, #d9d9d9 100%);
      font-family: 'DM Sans', 'Noto Serif TC', sans-serif;
      color: #111827;
    }

    .app-wrapper{
      width: min(520px, 92vw);
    }

    .app-title{ display:none; } /* 截圖沒有獨立標題，隱藏 */

    /* 相機外殼：直式、圓角、金屬感 */
    .camera-body{
      position: relative;
      border-radius: 26px;
      padding: 0;
      overflow: hidden;
      background: linear-gradient(180deg, var(--metal1) 0%, var(--metal2) 55%, var(--metal3) 100%);
      border: 1px solid rgba(0,0,0,.18);
      box-shadow: 0 26px 55px rgba(0,0,0,.28);
    }

    /* 頂部皮革橫條（含車線、壓紋） */
    .camera-top-strip{
      position: relative;
      height: 92px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.10)),
        repeating-linear-gradient(90deg, rgba(255,255,255,.06) 0, rgba(255,255,255,.06) 2px, rgba(0,0,0,.02) 2px, rgba(0,0,0,.02) 10px),
        linear-gradient(180deg, var(--leather1), var(--leather2));
      border-bottom: 1px solid rgba(0,0,0,.18);
    }
    .camera-top-strip:before{
      content:"";
      position:absolute;
      left:18px; right:18px; top:18px; bottom:18px;
      border-radius: 14px;
      border: 2px solid rgba(255,255,255,.20);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
      opacity:.9;
    }
    .camera-top-strip:after{
      content:"";
      position:absolute;
      left:30px; right:30px; top:30px; bottom:30px;
      border-radius: 12px;
      border: 1px dashed rgba(212,177,132,.85);
      opacity:.9;
    }

    /* 上方品牌列（紅燈+文字+右側小件） */
    .camera-header{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 18px 18px 14px;
      border-bottom: 1px solid rgba(0,0,0,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.10));
    }

    .camera-viewfinder{ /* 改成左邊紅燈 */
      width:22px; height:22px; border-radius:999px;
      background: radial-gradient(circle at 30% 20%, #ffb8ad, #d14a3c);
      border: 2px solid rgba(0,0,0,.25);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
      flex: 0 0 auto;
    }

    .camera-brand{
      flex: 1;
      padding-left: 12px;
      font-weight: 800;
      letter-spacing: .22em;
      text-transform: uppercase;
      font-size: 18px;
      color: rgba(0,0,0,.62);
      user-select:none;
    }

    /* 右側的小方塊+閃燈 */
    .camera-lens{
      width: 86px;
      height: 24px;
      border-radius: 8px;
      background: transparent;
      box-shadow: none;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:12px;
    }
    .camera-lens:before{
      content:"";
      width:14px; height:14px;
      border-radius: 3px;
      background: #d6dde4;
      border: 2px solid rgba(0,0,0,.22);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
      opacity:.9;
    }
    .camera-lens:after{
      content:"";
      width:46px; height:22px;
      border-radius: 8px;
      background:
        repeating-linear-gradient(90deg, rgba(255,255,255,.55) 0, rgba(255,255,255,.55) 2px, rgba(255,255,255,.22) 2px, rgba(255,255,255,.22) 5px),
        linear-gradient(180deg, rgba(255,255,255,.65), rgba(0,0,0,.12));
      border: 1px solid rgba(0,0,0,.22);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
    }

    /* 主體改成直式堆疊 */
    .camera-main{
      display:flex;
      flex-direction: column;
      gap: 18px;
      padding: 18px;
    }

    /* 黑色操作面板（含按鈕與詩句） */
    .control-panel{
      border-radius: 20px;
      padding: 16px;
      background:
        radial-gradient(circle at 50% 0%, rgba(255,255,255,.08), transparent 55%),
        linear-gradient(180deg, #15181d, #0b0c0f);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 10px 18px rgba(0,0,0,.22), inset 0 0 0 1px rgba(0,0,0,.45);
      color: var(--ink);
    }

    .control-panel > div:first-child{
      display:flex;
      gap: 14px;
      align-items:center;
    }

    /* 大白色 SHOOT / LOAD */
    .shutter-button{
      flex: 1;
      padding: 18px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: linear-gradient(180deg, #f7f7f7, #dcdcdc);
      color: #111827;
      font-weight: 900;
      font-size: 34px;
      letter-spacing: .12em;
      text-transform: uppercase;
      box-shadow: 0 10px 20px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.6);
    }
    .shutter-button:active{ transform: translateY(1px); }

    /* 右側小圓燈（灰色） */
    .indicator-light{
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #9aa3ab, #444b52);
      border: 2px solid rgba(255,255,255,.08);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
      flex: 0 0 auto;
    }
    .indicator-light.off{
      background: radial-gradient(circle at 30% 20%, #7b828a, #343a40);
      opacity: .85;
    }

    /* Play/Stop 大按鈕 */
    .sub-buttons{
      display:flex;
      gap: 16px;
      margin-top: 14px;
    }
    .sub-btn{
      flex:1;
      padding: 18px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(circle at 50% 0%, rgba(255,255,255,.10), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.25));
      color: rgba(233,236,239,.55);
      font-weight: 900;
      font-size: 30px;
      letter-spacing: .14em;
      text-transform: uppercase;
      cursor:pointer;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.55);
    }
    .sub-btn:disabled{
      opacity: .35;
      cursor: not-allowed;
    }

    /* 面板分隔線（虛線） */
    .tiny{
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px dashed rgba(233,236,239,.22);
      font-family: 'Noto Serif TC', serif;
      font-style: normal;
      font-size: 22px;
      line-height: 1.6;
      color: rgba(233,236,239,.92);
      letter-spacing: .02em;
    }

    /* barcode 置中 */
    .camera-footer{
      margin-top: 18px;
      padding-top: 18px;
      border-top: 0;
    }
    .footer-row{
      display:flex;
      justify-content:center;
      align-items:center;
      gap: 10px;
      color: transparent; /* 截圖沒有這行字，隱藏 */
      height: 0;
      overflow:hidden;
    }

    .polaroid-caption{
      text-align:center;
      margin-top: 12px;
      font-family: 'Libre Barcode 39 Text';
      font-size: 44px;
      letter-spacing: .08em;
      color: rgba(233,236,239,.70);
      line-height: 1;
    }

    /* 下方出片艙：大灰色區塊 + 底部長條槽 */
    .photo-slot{
      position: relative;
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(0,0,0,.10), rgba(255,255,255,.06));
      border: 1px solid rgba(0,0,0,.20);
      padding: 16px;
      min-height: 360px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
      overflow: hidden;
    }

    /* 內層灰色面板 */
    .photo-slot:before{
      content:"";
      position:absolute;
      inset: 14px;
      border-radius: 18px;
      background: linear-gradient(180deg, #c3c8cd, #9fa6ad);
      border: 1px solid rgba(0,0,0,.15);
      box-shadow: inset 0 10px 30px rgba(0,0,0,.12);
    }

    /* 底部出片槽 */
    .film-slot{
      position:absolute;
      left: 30px;
      right: 30px;
      bottom: 26px;
      height: 18px;
      border-radius: 999px;
      background: #0b0c0e;
      box-shadow: inset 0 2px 10px rgba(0,0,0,.75);
      border: 1px solid rgba(255,255,255,.06);
      z-index: 6;
      margin-top: 0;
    }

    /* Polaroid 片：從底部槽「吐出」 */
    .polaroid-frame{
      position: absolute;
      left: 50%;
      bottom: 10px;
      transform: translate(-50%, 140%);
      width: 280px;
      max-width: 84%;
      background: #fdfdf9;
      border-radius: 10px;
      padding: 12px 12px 34px;
      box-shadow: 0 18px 30px rgba(0,0,0,.35);
      opacity: 0;
      z-index: 5;
      --developDur: 2.5s;
    }

    .polaroid-frame.eject { animation: ejectFilm 0.9s ease-out forwards; }
    @keyframes ejectFilm {
      0%   { transform: translate(-50%, 140%); opacity: 0; }
      100% { transform: translate(-50%, 18%);  opacity: 1; }
    }

    .polaroid-inner{
      width: 100%;
      aspect-ratio: 1;
      background: #e5e7eb; /* ✅ 保留原本 */
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
      border-radius: 8px;
    }

    /* 保留顯影效果（不動） */
    .film-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
    .grain { position: absolute; width: 100%; height: 100%; background-image: url("https://www.transparenttextures.com/patterns/stardust.png"); opacity: 0.2; mix-blend-mode: overlay; }
    .light-leak { position: absolute; width: 100%; height: 100%; background: radial-gradient(circle at 0% 50%, rgba(255, 80, 0, 0.4) 0%, transparent 60%), radial-gradient(circle at 100% 10%, rgba(255, 150, 50, 0.2) 0%, transparent 50%); mix-blend-mode: screen; filter: blur(10px); }

    /* ====== ✅ 唯一修改點：照片完整呈現（不裁切） ====== */
    #preview {
      width: 100%;
      height: 100%;

      /* 原本是 cover 會裁切，改成 contain 讓整張照片完整顯示 */
      object-fit: contain;

      /* 留白時給一個深色底，避免像破圖 */
      background: #0b0c0f;

      opacity: 0;
      filter: brightness(0.05) contrast(0.6) saturate(0.1);
      transition: opacity var(--developDur) linear, filter var(--developDur) linear;
    }
    #preview.develop { opacity: 1; filter: sepia(0.3) contrast(1.2) brightness(1.05) saturate(1.1); }
    /* ====== ✅ 修改點到此結束 ====== */

    /* 你原本的 camera overlay（拍照/相簿）保留不動 */
    #cameraOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
    }
    #videoPreview { width: 100%; max-width: 420px; aspect-ratio: 1; object-fit: cover; }
    .camera-controls { margin-top: 30px; display: flex; gap: 30px; align-items: center; }
    .snap-btn { width: 70px; height: 70px; border-radius: 50%; background: #fff; border: 6px solid #444; }
    .overlay-close { position: absolute; top: 20px; right: 20px; color: #fff; font-size: 30px; background: none; border: none; }
    .album-btn { background: #444; color: #fff; border: none; padding: 10px 20px; border-radius: 20px; }

    #canvas { display: none; }
  </style>
</head>

<body>
  <div class="app-wrapper">
    <div class="app-title"><h1>Music Camera 聽見風景</h1></div>

    <div class="camera-body">
      <div class="camera-top-strip"></div>

      <div class="camera-header">
        <div class="camera-viewfinder"></div>
        <div class="camera-brand">MUSIC CAMERA</div>
        <div class="camera-lens"></div>
      </div>

      <div class="camera-main">
        <!-- 黑色操作面板 -->
        <div class="control-panel">
          <div>
            <button id="openCamBtn" class="shutter-button">SHOOT / LOAD</button>
            <div id="indicator" class="indicator-light off"></div>
          </div>

          <div class="sub-buttons">
            <button id="playBtn" class="sub-btn" disabled>PLAY</button>
            <button id="stopBtn" class="sub-btn" disabled>STOP</button>
          </div>

          <div class="tiny" id="analysisText">每一個當下都是一段獨一無二的旋律</div>

          <!-- 截圖中的條碼字樣（captionText 的 id 必須保留，JS 會寫入） -->
          <div class="camera-footer">
            <div class="footer-row"><span>視覺數據轉化為專屬情緒旋律</span></div>
            <div class="polaroid-caption" id="captionText">LO-FI_VIBE_READY</div>
          </div>
        </div>

        <!-- 下方吐照片艙 -->
        <div class="photo-slot">
          <div class="polaroid-frame" id="polaroidFrame">
            <div class="polaroid-inner">
              <div class="film-overlay"><div class="grain"></div><div class="light-leak"></div></div>
              <img id="preview" alt="Snapshot"/>
            </div>
          </div>

          <!-- 底部出片槽（保留原 class 名稱 film-slot，JS 不用它） -->
          <div class="film-slot"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="cameraOverlay">
    <button class="overlay-close" id="closeOverlay">✕</button>
    <video id="videoPreview" autoplay playsinline></video>
    <div class="camera-controls">
      <button class="album-btn" id="albumBtn">相簿</button>
      <button class="snap-btn" id="snapBtn"></button>
      <div style="width:60px;"></div>
    </div>
    <input type="file" id="fileInput" accept="image/*" style="display:none;">
  </div>

  <canvas id="canvas"></canvas>
  <audio id="shutterSfx" src="https://raw.githubusercontent.com/OOOOuOOOO/Musiccamera/assets/polaroid-shutter.mp3" preload="auto"></audio>

  <script>
    const openCamBtn = document.getElementById('openCamBtn');
    const cameraOverlay = document.getElementById('cameraOverlay');
    const videoPreview = document.getElementById('videoPreview');
    const snapBtn = document.getElementById('snapBtn');
    const albumBtn = document.getElementById('albumBtn');
    const fileInput = document.getElementById('fileInput');
    const closeOverlay = document.getElementById('closeOverlay');
    const preview = document.getElementById('preview');
    const indicator = document.getElementById('indicator');
    const polaroidFrame = document.getElementById('polaroidFrame');
    const analysisText = document.getElementById('analysisText');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const shutterSfx = document.getElementById('shutterSfx');
    const canvas = document.getElementById('canvas');

    let stream = null;
    let audioInited = false;
    let currentFeatures = null;
    let synths = {};

    // --- 相機控制 (維持原設定) ---
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        videoPreview.srcObject = stream;
        cameraOverlay.style.display = 'flex';
      } catch (e) { fileInput.click(); }
    }
    function stopCamera() {
      if (stream) stream.getTracks().forEach(t => t.stop());
      cameraOverlay.style.display = 'none';
    }
    openCamBtn.addEventListener('click', startCamera);
    closeOverlay.addEventListener('click', stopCamera);
    albumBtn.addEventListener('click', () => fileInput.click());
    snapBtn.addEventListener('click', () => {
      const ctx = canvas.getContext('2d');
      canvas.width = videoPreview.videoWidth;
      canvas.height = videoPreview.videoHeight;
      ctx.drawImage(videoPreview, 0, 0);
      preview.src = canvas.toDataURL('image/jpeg');
      stopCamera();
      analyzePhoto();
    });
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => { preview.src = ev.target.result; stopCamera(); analyzePhoto(); };
      reader.readAsDataURL(file);
    });

    // --- 照片分析與感應 (核心音樂情境變量) ---
    function analyzePhoto() {
      preview.onload = () => {
        const ctx = canvas.getContext('2d');
        canvas.width = 10; canvas.height = 10;
        ctx.drawImage(preview, 0, 0, 10, 10);
        const data = ctx.getImageData(0, 0, 10, 10).data;
        let r=0, g=0, b=0, bri=0;
        for(let i=0; i<data.length; i+=4){ r+=data[i]; g+=data[i+1]; b+=data[i+2]; bri+=(data[i]+data[i+1]+data[i+2])/3; }

        const avgR = r/100, avgB = b/100, avgBri = bri/100;

        // 生成根據照片變化的音樂參數
        currentFeatures = {
          mode: avgBri > 125 ? 'Major' : 'Minor', // 亮：大調(溫暖) / 暗：小調(沈靜)
          vibe: avgR > avgB ? 'Warm' : 'Cool',    // 色溫決定配器比例
          bpm: 86 + Math.floor((avgBri/255) * 12), // 亮度決定節奏速度
          seed: r + g + b
        };

        indicator.classList.remove('off');
        analysisText.innerHTML = `Vibe: ${currentFeatures.mode} & ${currentFeatures.vibe}<br>16-Bar Lo-Fi Ready`;
        document.getElementById('captionText').innerText = `DATA_${currentFeatures.mode}_${currentFeatures.vibe}`;

        triggerEject();
      };
    }

    function triggerEject() {
      polaroidFrame.classList.remove('eject'); void polaroidFrame.offsetWidth; polaroidFrame.classList.add('eject');
      preview.classList.remove('develop');
      shutterSfx.currentTime = 0; shutterSfx.play();
      setTimeout(() => preview.classList.add('develop'), 50);
      shutterSfx.onended = () => { playBtn.disabled = false; };
    }

    // --- 音樂引擎 (Lo-Fi 重構版) ---
    async function initAudio() {
      if (audioInited) return;
      await Tone.start();
      const filter = new Tone.Filter(1300, "lowpass").toDestination();
      const reverb = new Tone.Reverb({ decay: 6, wet: 0.35 }).connect(filter);

      // 電鋼琴 (主要旋律)
      synths.piano = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "triangle" },
        envelope: { attack: 0.1, release: 2 },
        volume: -5
      }).connect(reverb);

      // 療癒吉他
      synths.guitar = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "sine" },
        envelope: { attack: 0.05, decay: 0.3, release: 1 },
        volume: -10
      }).connect(reverb);

      // Lo-Fi 鼓組
      synths.kick = new Tone.MembraneSynth({ volume: -14 }).connect(filter);
      synths.snare = new Tone.NoiseSynth({ volume: -26 }).connect(filter);
      synths.hihat = new Tone.MetalSynth({ volume: -32, envelope: { decay: 0.05 } }).connect(filter);

      audioInited = true;
    }

    playBtn.addEventListener('click', async () => {
      await initAudio();
      Tone.Transport.stop(); Tone.Transport.cancel();

      const f = currentFeatures;
      Tone.Transport.bpm.value = f.bpm;

      // 根據照片性質選擇音階庫
      const scale = f.mode === 'Major'
        ? ["C4", "E4", "G4", "A4", "B4", "D5"]
        : ["A3", "C4", "D4", "E4", "G4", "A4"];

      const sequence = [];
      for (let bar = 0; bar < 16; bar++) {
        // 標準 Lo-Fi 節拍 (1,3 拍大鼓; 2,4 拍小鼓)
        sequence.push({ time: `${bar}:0:0`, type: "kick" });
        sequence.push({ time: `${bar}:1:0`, type: "snare" });
        sequence.push({ time: `${bar}:2:0`, type: "kick" });
        sequence.push({ time: `${bar}:3:0`, type: "snare" });
        for (let i = 0; i < 8; i++) sequence.push({ time: `${bar}:0:${i*2}`, type: "hihat" });

        // 根據 Vibe (暖/冷) 分配旋律角色
        if (f.vibe === 'Warm') {
          // 暖色調：吉他為主，彈奏切分音
          sequence.push({ time: `${bar}:0:2`, type: "guitar", note: scale[bar % scale.length] });
          sequence.push({ time: `${bar}:2:1`, type: "guitar", note: scale[(bar+2) % scale.length] });
          if(bar % 2 === 0) sequence.push({ time: `${bar}:0:0`, type: "piano", notes: [scale[0], scale[2]] });
        } else {
          // 冷色調：鋼琴為主，彈奏厚重長音
          sequence.push({ time: `${bar}:0:0`, type: "piano", notes: [scale[0], scale[2], scale[4]] });
          if(bar % 4 === 2) sequence.push({ time: `${bar}:2:0`, type: "piano", notes: [scale[1], scale[3]] });
          sequence.push({ time: `${bar}:3:2`, type: "guitar", note: scale[5] });
        }
      }

      new Tone.Part((time, v) => {
        if (v.type === "kick") synths.kick.triggerAttackRelease("C1", "8n", time);
        if (v.type === "snare") synths.snare.triggerAttack(time);
        if (v.type === "hihat") synths.hihat.triggerAttackRelease("C4", "32n", time, 0.3);
        if (v.type === "piano") synths.piano.triggerAttackRelease(v.notes, "1n", time, 0.5);
        if (v.type === "guitar") synths.guitar.triggerAttackRelease(v.note, "4n", time, 0.6);
      }, sequence).start(0);

      Tone.Transport.loop = true;
      Tone.Transport.loopEnd = "16m";
      Tone.Transport.start("+0.1");

      stopBtn.disabled = false;
      playBtn.disabled = true;
    });

    stopBtn.addEventListener('click', () => {
      Tone.Transport.stop();
      playBtn.disabled = false;
      stopBtn.disabled = true;
    });
  </script>
</body>
</html>
