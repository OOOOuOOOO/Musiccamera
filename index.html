<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Music Camera - StreetVoice Inspired</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@700&family=Noto+Serif+TC:wght@600&family=Nanum+Pen+Script&display=swap');
    * { box-sizing: border-box; }
    body { margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #e0e0e0; font-family: 'DM Sans', sans-serif; }
    .camera-container { width: 380px; background: linear-gradient(180deg, #e8e8e8 0%, #d1d1d1 100%); border-radius: 25px; box-shadow: 0 30px 60px rgba(0,0,0,0.3); position: relative; overflow: hidden; border: 1px solid #b5b5b5; }
    .camera-top { height: 70px; background: #9d6d48; border-bottom: 2px solid #7d5233; display: flex; align-items: center; justify-content: center; }
    .leather-stitch { width: 90%; height: 45px; border: 1px dashed rgba(255,255,255,0.3); border-radius: 10px; }
    .brand-bar { padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; color: #555; font-size: 14px; font-weight: bold; }
    .red-dot { width: 14px; height: 14px; background: radial-gradient(circle at 30% 30%, #ff7e7e, #b30000); border-radius: 50%; display: inline-block; margin-right: 8px; }
    .control-center { margin: 0 15px; background: #1a1a1a; border-radius: 20px; padding: 25px 20px; color: #fff; text-align: center; }
    .mode-switch-group { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
    .mode-btn { padding: 6px 15px; border-radius: 15px; border: 1px solid #444; background: #222; color: #777; font-size: 12px; cursor: pointer; }
    .mode-btn.active { background: #9d6d48; color: #fff; }
    .main-btn { width: 100%; height: 50px; background: linear-gradient(180deg, #fff 0%, #e0e0e0 100%); border-radius: 25px; border: none; font-size: 18px; font-weight: 800; cursor: pointer; margin-bottom: 12px; }
    .sub-btn-group { display: flex; gap: 10px; margin-bottom: 10px; }
    .sub-btn { flex: 1; height: 40px; background: #222; border-radius: 20px; border: 1px solid #444; color: #777; font-weight: bold; cursor: pointer; }
    .sub-btn:enabled { color: #fff; }
    .analysis-text { font-family: 'Noto Serif TC', serif; font-size: 16px; margin: 15px 0 5px; }
    .eject-slot-container { margin: 20px 15px 25px; padding: 15px; background: #bababa; border-radius: 15px; min-height: 300px; position: relative; overflow: hidden; display: flex; justify-content: center; }
    .polaroid-film { width: 220px; background: #fff; padding: 10px 10px 45px 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); position: absolute; transform: translateY(150%); transition: transform 1.2s cubic-bezier(0.17, 0.67, 0.83, 0.67); }
    .polaroid-film.eject { transform: translateY(5%); }
    .film-inner { width: 100%; aspect-ratio: 1; background: #222; position: relative; overflow: hidden; }
    .film-inner::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(255,80,0,0.4) 0%, transparent 70%); mix-blend-mode: screen; opacity: 0; }
    .polaroid-film.eject .film-inner::after { opacity: 1; transition: opacity 4s 1s; }
    #preview { width: 100%; height: 100%; object-fit: cover; opacity: 0; }
    #preview.develop { opacity: 1; transition: opacity 3.5s; filter: sepia(0.2) contrast(0.9); }
    .film-date { position: absolute; bottom: 12px; right: 15px; font-family: 'Nanum Pen Script', cursive; font-size: 20px; color: #444; opacity: 0; }
    .film-date.show { opacity: 1; transition: opacity 2s 1.5s; }
    #cameraOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
    #videoPreview { width: 100%; max-height: 70vh; object-fit: contain; }
  </style>
</head>
<body>
  <div class="camera-container">
    <div class="camera-top"><div class="leather-stitch"></div></div>
    <div class="brand-bar"><div><span class="red-dot"></span>MUSIC CAMERA 聽見風景</div></div>
    <div class="control-center">
      <div class="mode-switch-group">
        <button class="mode-btn active" id="lofiModeBtn">LO-FI</button>
        <button class="mode-btn" id="jazzModeBtn">JAZZ</button>
      </div>
      <button class="main-btn" id="openCamBtn">SHOOT / LOAD</button>
      <div class="sub-btn-group">
        <button class="sub-btn" id="playBtn" disabled>PLAY</button>
        <button class="sub-btn" id="stopBtn" disabled>STOP</button>
      </div>
      <div class="analysis-text" id="analysisText">讓音樂完整回憶</div>
    </div>
    <div class="eject-slot-container">
      <div class="polaroid-film" id="polaroidFrame">
        <div class="film-inner"><img id="preview" /></div>
        <div class="film-date" id="filmDate"></div>
      </div>
      <div style="position:absolute; bottom:15px; width:92%; height:10px; background:#000; border-radius:5px;"></div>
    </div>
  </div>
  <div id="cameraOverlay">
    <video id="videoPreview" autoplay playsinline muted></video>
    <div style="margin-top:30px; display:flex; gap:40px;">
      <button id="albumBtn" style="background:#444; color:#fff; border:none; padding:10px 20px; border-radius:20px;">相簿</button>
      <button class="snap-trigger" id="snapBtn" style="width:70px; height:70px; border-radius:50%; background:#fff; border:5px solid #9d6d48;"></button>
      <button id="closeOverlay" style="color:white; background:none; border:none;">✕</button>
    </div>
  </div>
  <input type="file" id="fileInput" accept="image/*" style="display:none;">
  <canvas id="canvas" style="display:none;"></canvas>
  <audio id="shutterSfx" src="https://assets.mixkit.co/active_storage/sfx/702/702-preview.mp3"></audio>

  <script>
    const openCamBtn = document.getElementById('openCamBtn'), cameraOverlay = document.getElementById('cameraOverlay'), videoPreview = document.getElementById('videoPreview'), snapBtn = document.getElementById('snapBtn'), albumBtn = document.getElementById('albumBtn'), fileInput = document.getElementById('fileInput'), closeOverlay = document.getElementById('closeOverlay'), preview = document.getElementById('preview'), polaroidFrame = document.getElementById('polaroidFrame'), analysisText = document.getElementById('analysisText'), playBtn = document.getElementById('playBtn'), stopBtn = document.getElementById('stopBtn'), filmDate = document.getElementById('filmDate'), shutterSfx = document.getElementById('shutterSfx'), canvas = document.getElementById('canvas'), lofiModeBtn = document.getElementById('lofiModeBtn'), jazzModeBtn = document.getElementById('jazzModeBtn');

    let stream = null, audioInited = false, currentFeatures = null, synths = {}, musicMode = 'lofi';

    // 1. StreetVoice 靈感配方：確保每組和弦都「好聽」
    const lofiPresets = {
      warm: { bpm: 92, chords: [["Fmaj7","A4","C5","E5"], ["Em7","G4","B4","D5"], ["Dm7","F4","A4","C5"], ["Cmaj7","E4","G4","B4"]], vibe: "清脆午後" },
      chill: { bpm: 88, chords: [["Dbmaj7","F4","Ab4","C5"], ["C7","E4","G4","Bb4"], ["Fm7","Ab4","C5","Eb5"], ["Eb7","G4","Bb4","Db5"]], vibe: "微醺都市" },
      deep: { bpm: 84, chords: [["Bbm9","Db4","F4","Ab4","C5"], ["Eb13","G4","Db5","F5"], ["Abmaj9","C4","G4","Bb4"], ["F7","A4","Eb5","G5"]], vibe: "深夜回憶" }
    };

    lofiModeBtn.onclick = () => { musicMode = 'lofi'; lofiModeBtn.classList.add('active'); jazzModeBtn.classList.remove('active'); };
    jazzModeBtn.onclick = () => { musicMode = 'jazz'; jazzModeBtn.classList.add('active'); lofiModeBtn.classList.remove('active'); };

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        videoPreview.srcObject = stream; cameraOverlay.style.display = 'flex';
      } catch (e) { fileInput.click(); }
    }
    openCamBtn.onclick = startCamera;
    closeOverlay.onclick = () => { if(stream) stream.getTracks().forEach(t=>t.stop()); cameraOverlay.style.display='none'; };
    albumBtn.onclick = () => fileInput.click();

    snapBtn.onclick = () => {
      canvas.width = videoPreview.videoWidth; canvas.height = videoPreview.videoHeight;
      canvas.getContext('2d').drawImage(videoPreview, 0, 0);
      preview.src = canvas.toDataURL('image/jpeg');
      cameraOverlay.style.display = 'none'; analyzePhoto();
    };

    fileInput.onchange = (e) => {
      const reader = new FileReader();
      reader.onload = (ev) => { preview.src = ev.target.result; analyzePhoto(); };
      reader.readAsDataURL(e.target.files[0]);
    };

    function analyzePhoto() {
      preview.onload = () => {
        const ctx = canvas.getContext('2d'); ctx.drawImage(preview, 0, 0, 10, 10);
        const d = ctx.getImageData(0,0,10,10).data;
        let r=0, b=0, bri=0;
        for(let i=0; i<d.length; i+=4){ r+=d[i]; b+=d[i+2]; bri+=(d[i]+d[i+1]+d[i+2])/3; }
        
        let mood = "chill";
        if (bri > 160) mood = "warm";
        else if (b > r) mood = "deep";
        
        currentFeatures = { mood: mood, seed: r+b };
        triggerEject();
      };
    }

    function triggerEject() {
      const now = new Date();
      filmDate.innerText = `${now.getFullYear()}.${now.getMonth()+1}.${now.getDate()}`;
      polaroidFrame.classList.remove('eject');
      void polaroidFrame.offsetWidth;
      polaroidFrame.classList.add('eject');
      preview.classList.remove('develop');
      shutterSfx.play().catch(()=>{});
      setTimeout(() => { preview.classList.add('develop'); filmDate.classList.add('show'); }, 100);
      playBtn.disabled = false;
    }

    async function initAudio() {
      if (audioInited) return;
      await Tone.start();
      const filter = new Tone.Filter(1200, "lowpass").toDestination();
      synths.rev = new Tone.Reverb({ decay: 4, wet: 0.3 }).connect(filter);
      
      // Lo-fi 靈魂：讓音高晃動的 LFO
      synths.wobble = new Tone.LFO(3, -15, 15).start();
      
      synths.piano = new Tone.Sampler({
        urls: { A1: "A1.mp3", C4: "C4.mp3" },
        baseUrl: "https://tonejs.github.io/audio/salamander/",
      }).connect(synths.rev);

      synths.kick = new Tone.MembraneSynth({ volume: -10 }).connect(filter);
      synths.snare = new Tone.NoiseSynth({ volume: -25 }).connect(filter);
      synths.bass = new Tone.MonoSynth({ volume: -15, oscillator: {type:"sine"} }).connect(filter);
      audioInited = true;
    }

    playBtn.onclick = async () => {
      await initAudio();
      Tone.Transport.stop(); Tone.Transport.cancel();
      
      const config = lofiPresets[currentFeatures.mood];
      Tone.Transport.bpm.value = config.bpm;
      const sequence = [];

      if (musicMode === 'lofi') {
        // --- 核心改動：StreetVoice 式結構生成 ---
        for (let bar = 0; bar < 8; bar++) {
          const chord = config.chords[bar % config.chords.length];
          const root = chord[0].replace('maj7','').replace('m7','').replace('m9','') + "2";
          
          // 1. 每小節第一拍的大和弦 (穩定感)
          sequence.push({ time: `${bar}:0:0`, type: "piano", notes: chord.slice(1), dur: "1n" });
          sequence.push({ time: `${bar}:0:0`, type: "bass", note: root });

          // 2. 隨機裝飾旋律 (只彈和弦內音，保證好聽)
          if (bar % 1 === 0) {
            const melodyNote = chord[Math.floor(Math.random() * (chord.length-1)) + 1];
            sequence.push({ time: `${bar}:2:2`, type: "piano", notes: [melodyNote], dur: "4n" });
          }

          // 3. 不對齊的 Lo-fi 節奏 (Swing)
          sequence.push({ time: `${bar}:0:0.1`, type: "kick" });
          sequence.push({ time: `${bar}:1:0.2`, type: "snare" });
          sequence.push({ time: `${bar}:2:0.1`, type: "kick" });
          sequence.push({ time: `${bar}:3:0.2`, type: "snare" });
        }
      } else {
        // --- 完全還原的 Jazz 模式 (隔離保護) ---
        const jazzScale = ["C3", "Eb3", "F3", "G3", "Bb3"];
        for (let bar = 0; bar < 8; bar++) {
          sequence.push({ time: `${bar}:0:0`, type: "bass", note: jazzScale[bar%5] });
          if(bar%2===0) sequence.push({ time: `${bar}:0:2`, type: "piano", notes: ["C4","Eb4","G4"], dur: "2n" });
        }
      }

      new Tone.Part((time, v) => {
        if (v.type === "kick") synths.kick.triggerAttackRelease("C1", "8n", time);
        if (v.type === "snare") synths.snare.triggerAttack(time);
        if (v.type === "bass") synths.bass.triggerAttackRelease(v.note, "2n", time);
        if (v.type === "piano") {
          synths.piano.triggerAttackRelease(v.notes, v.dur, time, 0.5);
        }
      }, sequence).start(0);

      Tone.Transport.loop = true; Tone.Transport.loopEnd = "8m";
      Tone.Transport.start("+0.1");
      playBtn.disabled = true; stopBtn.disabled = false;
    };

    stopBtn.onclick = () => { Tone.Transport.stop(); playBtn.disabled = false; stopBtn.disabled = true; };
  </script>
</body>
</html>
